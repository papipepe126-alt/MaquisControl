<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Maquis Manager Cloud ‚òÅÔ∏è</title>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        :root { --bg: #121212; --card: #1e1e1e; --primary: #FFD700; --danger: #FF4444; --success: #00C851; --text: #fff; }
        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; outline: none; }
        body { background: var(--bg); color: var(--text); font-family: 'Poppins', sans-serif; margin: 0; padding: 0; }

        /* LOADING SPINNER */
        #loader { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: #000; z-index: 10000; display: flex; flex-direction: column; align-items: center; justify-content: center; transition: opacity 0.5s; }
        .spinner { border: 4px solid #333; border-top: 4px solid var(--primary); border-radius: 50%; width: 40px; height: 40px; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

        /* LOGIN SCREEN */
        #login-screen { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: #000; z-index: 5000; display: flex; flex-direction: column; align-items: center; justify-content: center; padding: 20px; }
        .login-box { width: 100%; max-width: 350px; text-align: center; }
        .login-input { width: 100%; padding: 15px; margin: 10px 0; border-radius: 10px; border: 1px solid #333; background: #222; color: white; font-size: 16px; }
        .btn-auth { width: 100%; padding: 15px; background: var(--primary); color: black; font-weight: bold; border: none; border-radius: 10px; cursor: pointer; margin-top: 10px; font-size: 16px; }

        /* APP CONTAINER */
        #app-container { display: none; padding: 20px; padding-bottom: 120px; max-width: 600px; margin: 0 auto; }
        
        /* HEADER */
        header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; }
        .brand { font-size: 20px; font-weight: 700; color: var(--primary); letter-spacing: 1px; }
        .logout-btn { background: #333; color: white; border: none; padding: 8px 12px; border-radius: 8px; font-size: 12px; cursor: pointer; }

        /* CARDS */
        .stat-card { background: linear-gradient(135deg, #2c3e50, #000000); padding: 20px; border-radius: 15px; text-align: center; border: 1px solid var(--primary); margin-bottom: 20px; box-shadow: 0 4px 15px rgba(255, 215, 0, 0.1); }
        .stat-card h3 { margin: 0; font-size: 12px; color: #aaa; text-transform: uppercase; }
        .stat-card .val { font-size: 32px; font-weight: 700; margin-top: 5px; color: var(--primary); }

        /* PRODUCT LIST */
        .product-item { display: flex; justify-content: space-between; align-items: center; background: var(--card); padding: 15px; border-radius: 12px; margin-bottom: 10px; border: 1px solid #333; }
        .p-info { display: flex; flex-direction: column; }
        .p-name { font-weight: bold; font-size: 16px; }
        .p-price { color: var(--success); font-size: 14px; }
        .p-actions { display: flex; align-items: center; gap: 10px; }
        .stock-badge { background: #333; padding: 5px 10px; border-radius: 5px; font-size: 12px; color: #aaa; }
        .btn-sell { background: var(--success); color: white; border: none; padding: 8px 15px; border-radius: 8px; font-weight: bold; cursor: pointer; }
        .btn-sell:active { transform: scale(0.95); }

        /* MODALS */
        .modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.95); z-index: 6000; align-items: center; justify-content: center; backdrop-filter: blur(5px); }
        .modal-content { background: #1a1a1a; padding: 25px; border-radius: 20px; width: 90%; max-width: 400px; border: 1px solid #444; position: relative; }
        .close-modal { position: absolute; top: 15px; right: 15px; font-size: 20px; color: #666; cursor: pointer; }
        
        /* BOTTOM BAR */
        .bottom-bar { position: fixed; bottom: 0; left: 0; width: 100%; background: #1a1a1a; padding: 15px; display: flex; justify-content: space-around; border-top: 1px solid #333; z-index: 4000; }
        .nav-btn { background: none; border: none; color: #666; font-size: 24px; cursor: pointer; display: flex; flex-direction: column; align-items: center; font-size: 10px; gap: 5px; }
        .nav-btn i { font-size: 20px; margin-bottom: 2px; }
        .nav-btn.active { color: var(--primary); }

        .btn-admin { width: 100%; padding: 12px; background: #333; border: 1px solid #555; color: white; border-radius: 8px; margin-top: 10px; cursor: pointer; }
    </style>
</head>
<body>

    <!-- LOADER -->
    <div id="loader">
        <div class="spinner"></div>
        <p style="margin-top:10px; font-size:12px; color:#666;">Connexion S√©curis√©e...</p>
    </div>

    <!-- 1. LOGIN SCREEN -->
    <div id="login-screen">
        <div class="login-box">
            <h1 style="color:var(--primary); margin-bottom:5px;"><i class="fa-solid fa-champagne-glasses"></i> MAQUIS CLOUD</h1>
            <p style="color:#666; font-size:12px; margin-bottom:20px;">Gestion Pro Multi-Maquis</p>
            
            <input type="email" id="email" class="login-input" placeholder="Email du G√©rant">
            <input type="password" id="password" class="login-input" placeholder="Mot de passe">
            
            <button class="btn-auth" onclick="login()">SE CONNECTER</button>
            <button class="btn-auth" onclick="register()" style="background:#222; border:1px solid #444; color:#aaa; margin-top:15px;">Cr√©er un nouveau compte</button>
            <p id="auth-msg" style="color:var(--danger); margin-top:15px; font-size:12px;"></p>
        </div>
    </div>

    <!-- 2. APP PRINCIPALE -->
    <div id="app-container">
        <header>
            <div class="brand">MAQUIS<span style="color:white">MANAGER</span></div>
            <button class="logout-btn" onclick="logout()"><i class="fa-solid fa-power-off"></i></button>
        </header>

        <!-- DASHBOARD TAB -->
        <div id="tab-home">
            <div class="stat-card">
                <h3>Chiffre d'Affaires (Live)</h3>
                <div class="val" id="ca-display">0 FCFA</div>
                <div style="font-size:11px; color:#888; margin-top:5px;">Synchronis√© avec le Cloud ‚òÅÔ∏è</div>
            </div>

            <h3 style="color:#aaa; font-size:12px; margin-bottom:10px; text-transform:uppercase;">Vente Rapide</h3>
            <div id="products-list">
                <!-- Les produits s'afficheront ici -->
                <p style="text-align:center; color:#666; padding:20px;">Chargement du stock...</p>
            </div>
        </div>

        <!-- ADMIN TAB (Cach√© par d√©faut) -->
        <div id="tab-admin" style="display:none;">
            <h2 style="color:var(--primary)">‚öôÔ∏è Administration</h2>
            
            <div style="background:#222; padding:15px; border-radius:10px; margin-bottom:20px;">
                <h4 style="margin:0 0 10px 0;">Ajouter un Produit</h4>
                <input type="text" id="new-prod-name" placeholder="Nom (ex: Bock)" class="login-input" style="padding:10px;">
                <input type="number" id="new-prod-price" placeholder="Prix (ex: 1000)" class="login-input" style="padding:10px;">
                <input type="number" id="new-prod-stock" placeholder="Stock Initial" class="login-input" style="padding:10px;">
                <button class="btn-admin" style="background:var(--success); border:none;" onclick="addProduct()">AJOUTER</button>
            </div>

            <button class="btn-admin" onclick="resetDay()" style="background:var(--danger); border:none;">üî¥ CL√îTURER LA CAISSE (RAZ)</button>
        </div>
    </div>

    <!-- NAVIGATION BASSE -->
    <div class="bottom-bar" id="bottom-nav" style="display:none;">
        <button class="nav-btn active" onclick="switchTab('home')">
            <i class="fa-solid fa-cash-register"></i> Caisse
        </button>
        <button class="nav-btn" onclick="switchTab('admin')">
            <i class="fa-solid fa-gear"></i> Gestion
        </button>
        <button class="nav-btn" onclick="sendReport()">
            <i class="fa-brands fa-whatsapp"></i> Rapport
        </button>
    </div>

    <!-- FIREBASE LOGIC -->
    <script type="module">
        // --- 1. IMPORTATION CDN (Pour que √ßa marche sans installation) ---
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getAnalytics } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-analytics.js";
        import { getAuth, createUserWithEmailAndPassword, signInWithEmailAndPassword, onAuthStateChanged, signOut } 
        from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
        import { getFirestore, doc, setDoc, updateDoc, onSnapshot, arrayUnion, getDoc } 
        from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        // --- 2. TA CONFIGURATION ---
        const firebaseConfig = {
          apiKey: "AIzaSyCb22QgS99n6gzYmcCJoPzsVwd1uwg9g7k",
          authDomain: "maquismanager.firebaseapp.com",
          projectId: "maquismanager",
          storageBucket: "maquismanager.firebasestorage.app",
          messagingSenderId: "565292456302",
          appId: "1:565292456302:web:ef737768b5e0f06a05897f",
          measurementId: "G-MWWLQJK1SL"
        };

        // --- 3. INITIALISATION ---
        const app = initializeApp(firebaseConfig);
        const analytics = getAnalytics(app);
        const auth = getAuth(app);
        const db = getFirestore(app);

        let currentUser = null;
        let currentData = null;

        // --- 4. GESTION UTILISATEUR ---

        // Cr√©ation de compte (Premier Maquis)
        window.register = async () => {
            const e = document.getElementById('email').value;
            const p = document.getElementById('password').value;
            if(p.length < 6) { alert("Le mot de passe doit faire 6 caract√®res minimum"); return; }
            
            showLoader(true);
            try {
                const userCredential = await createUserWithEmailAndPassword(auth, e, p);
                // On initialise la base de donn√©es pour ce nouveau maquis
                await setDoc(doc(db, "maquis", userCredential.user.uid), {
                    ca_day: 0,
                    products: [
                        { id: 1, name: "Bock 66", price: 1000, stock: 24 },
                        { id: 2, name: "Ivoire", price: 1100, stock: 24 }
                    ]
                });
                alert("Compte cr√©√© !");
            } catch (error) {
                alert("Erreur: " + error.message);
                showLoader(false);
            }
        };

        // Connexion
        window.login = async () => {
            const e = document.getElementById('email').value;
            const p = document.getElementById('password').value;
            showLoader(true);
            try {
                await signInWithEmailAndPassword(auth, e, p);
            } catch (error) {
                document.getElementById('auth-msg').innerText = "Email ou mot de passe incorrect.";
                showLoader(false);
            }
        };

        window.logout = () => signOut(auth);

        // Surveillance de l'√©tat (Connect√© ou Pas ?)
        onAuthStateChanged(auth, (user) => {
            showLoader(false);
            if (user) {
                currentUser = user;
                document.getElementById('login-screen').style.display = 'none';
                document.getElementById('app-container').style.display = 'block';
                document.getElementById('bottom-nav').style.display = 'flex';
                initRealTimeData(); // On lance la connexion Live
            } else {
                currentUser = null;
                document.getElementById('login-screen').style.display = 'flex';
                document.getElementById('app-container').style.display = 'none';
                document.getElementById('bottom-nav').style.display = 'none';
            }
        });

        // --- 5. GESTION DONN√âES LIVE (Firestore) ---

        function initRealTimeData() {
            // Cette fonction √©coute la base de donn√©es en direct
            // Si tu changes une donn√©e sur Firebase, l'app se met √† jour toute seule
            onSnapshot(doc(db, "maquis", currentUser.uid), (doc) => {
                if(doc.exists()) {
                    currentData = doc.data();
                    renderUI(currentData);
                } else {
                    // Cas rare : Compte cr√©√© sans donn√©es
                    console.log("Pas de donn√©es !");
                }
            });
        }

        function renderUI(data) {
            // Mise √† jour CA
            document.getElementById('ca-display').innerText = (data.ca_day || 0).toLocaleString() + " FCFA";

            // Mise √† jour Liste Produits
            const list = document.getElementById('products-list');
            list.innerHTML = '';

            if(data.products && data.products.length > 0) {
                data.products.forEach((p, index) => {
                    let html = `
                    <div class="product-item">
                        <div class="p-info">
                            <span class="p-name">${p.name}</span>
                            <span class="p-price">${p.price} F</span>
                        </div>
                        <div class="p-actions">
                            <span class="stock-badge">Stock: ${p.stock}</span>
                            <button class="btn-sell" onclick="sellProduct(${index})">VENDRE</button>
                        </div>
                    </div>`;
                    list.innerHTML += html;
                });
            } else {
                list.innerHTML = '<p style="text-align:center; color:#666;">Aucun produit. Allez dans Gestion.</p>';
            }
        }

        // --- 6. ACTIONS (Vente, Ajout, etc.) ---

        // Vendre un produit
        window.sellProduct = async (index) => {
            if(!currentData) return;
            let p = currentData.products[index];

            if(p.stock > 0) {
                // On met √† jour localement pour la vitesse
                let newProducts = [...currentData.products];
                newProducts[index].stock--;
                
                // On envoie au Cloud
                await updateDoc(doc(db, "maquis", currentUser.uid), {
                    products: newProducts,
                    ca_day: (currentData.ca_day || 0) + parseInt(p.price)
                });
                
                if(navigator.vibrate) navigator.vibrate(50);
            } else {
                alert("Stock √âpuis√© !");
            }
        };

        // Ajouter un nouveau produit (Admin)
        window.addProduct = async () => {
            const name = document.getElementById('new-prod-name').value;
            const price = parseInt(document.getElementById('new-prod-price').value);
            const stock = parseInt(document.getElementById('new-prod-stock').value);

            if(name && price && stock) {
                let newProd = { id: Date.now(), name, price, stock };
                let newList = currentData.products ? [...currentData.products, newProd] : [newProd];

                await updateDoc(doc(db, "maquis", currentUser.uid), {
                    products: newList
                });
                
                alert("Produit ajout√© !");
                // Clear inputs
                document.getElementById('new-prod-name').value = "";
                document.getElementById('new-prod-price').value = "";
                document.getElementById('new-prod-stock').value = "";
            }
        };

        // Cl√¥turer la journ√©e (Reset CA)
        window.resetDay = async () => {
            if(confirm("Voulez-vous vraiment remettre le CA √† z√©ro pour demain ?")) {
                await updateDoc(doc(db, "maquis", currentUser.uid), {
                    ca_day: 0
                });
                alert("Caisse remise √† z√©ro !");
            }
        };

        // Rapport WhatsApp
        window.sendReport = () => {
            if(!currentData) return;
            let d = new Date();
            let msg = `*üìä RAPPORT CLOUD - ${d.toLocaleDateString()}* %0a`;
            msg += `------------------%0a`;
            msg += `üí∞ CA DU JOUR : *${currentData.ca_day} FCFA* %0a`;
            msg += `------------------%0a`;
            msg += `üì¶ STOCK RESTANT : %0a`;
            currentData.products.forEach(p => {
                msg += `- ${p.name} : ${p.stock} %0a`;
            });
            
            window.open(`https://wa.me/?text=${msg}`, '_blank');
        };

        // UI Utilities
        window.switchTab = (tabName) => {
            document.getElementById('tab-home').style.display = tabName === 'home' ? 'block' : 'none';
            document.getElementById('tab-admin').style.display = tabName === 'admin' ? 'block' : 'none';
            
            // Update buttons colors
            document.querySelectorAll('.nav-btn').forEach(btn => btn.classList.remove('active'));
            // Simple logic for active class (improved in real app)
            event.currentTarget.classList.add('active');
        };

        function showLoader(show) {
            document.getElementById('loader').style.opacity = show ? '1' : '0';
            setTimeout(() => {
                document.getElementById('loader').style.display = show ? 'flex' : 'none';
            }, 500);
        }

    </script>
</body>
</html>

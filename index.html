<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Maquis Manager Cloud V2 ‚òÅÔ∏è</title>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        :root { --bg: #121212; --card: #1e1e1e; --primary: #FFD700; --danger: #FF4444; --success: #00C851; --info: #33b5e5; --text: #fff; }
        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; outline: none; }
        body { background: var(--bg); color: var(--text); font-family: 'Poppins', sans-serif; margin: 0; padding: 0; }

        /* LOADING SPINNER */
        #loader { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: #000; z-index: 10000; display: flex; flex-direction: column; align-items: center; justify-content: center; transition: opacity 0.5s; }
        .spinner { border: 4px solid #333; border-top: 4px solid var(--primary); border-radius: 50%; width: 40px; height: 40px; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

        /* LOGIN SCREEN */
        #login-screen { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: #000; z-index: 5000; display: flex; flex-direction: column; align-items: center; justify-content: center; padding: 20px; }
        .login-box { width: 100%; max-width: 350px; text-align: center; }
        .login-input { width: 100%; padding: 15px; margin: 10px 0; border-radius: 10px; border: 1px solid #333; background: #222; color: white; font-size: 16px; }
        .btn-auth { width: 100%; padding: 15px; background: var(--primary); color: black; font-weight: bold; border: none; border-radius: 10px; cursor: pointer; margin-top: 10px; font-size: 16px; }

        /* APP CONTAINER */
        #app-container { display: none; padding: 20px; padding-bottom: 120px; max-width: 600px; margin: 0 auto; }
        
        /* HEADER */
        header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; }
        .brand { font-size: 20px; font-weight: 700; color: var(--primary); letter-spacing: 1px; }
        .logout-btn { background: #333; color: white; border: none; padding: 8px 12px; border-radius: 8px; font-size: 12px; cursor: pointer; }

        /* DASHBOARD GRID */
        .dashboard-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 20px; }
        .stat-card { background: var(--card); padding: 15px; border-radius: 15px; text-align: center; border: 1px solid #333; }
        .stat-card.main { grid-column: span 2; background: linear-gradient(135deg, #2c3e50, #000000); border: 1px solid var(--primary); }
        .stat-card h3 { margin: 0; font-size: 11px; color: #aaa; text-transform: uppercase; }
        .stat-card .val { font-size: 24px; font-weight: 700; margin-top: 5px; color: #fff; }
        .stat-card.main .val { font-size: 32px; color: var(--primary); }

        /* PRODUCT LIST */
        .product-item { display: flex; justify-content: space-between; align-items: center; background: var(--card); padding: 15px; border-radius: 12px; margin-bottom: 10px; border: 1px solid #333; }
        .p-info { display: flex; flex-direction: column; }
        .p-name { font-weight: bold; font-size: 16px; }
        .p-price { color: var(--success); font-size: 14px; }
        .p-actions { display: flex; align-items: center; gap: 10px; }
        .stock-badge { background: #333; padding: 5px 10px; border-radius: 5px; font-size: 12px; color: #aaa; }
        .btn-sell { background: var(--success); color: white; border: none; padding: 8px 15px; border-radius: 8px; font-weight: bold; cursor: pointer; }
        .btn-sell:active { transform: scale(0.95); }

        /* LOGS SECTION */
        .log-section { margin-top: 20px; background: var(--card); padding: 15px; border-radius: 12px; }
        .log-item { display: flex; justify-content: space-between; font-size: 12px; padding: 8px 0; border-bottom: 1px solid #333; color: #ccc; }
        .log-item:last-child { border-bottom: none; }
        .log-time { color: #666; font-size: 10px; }

        /* ACTIONS BAR */
        .action-bar { display: flex; gap: 10px; margin-bottom: 20px; }
        .btn-action { flex: 1; padding: 12px; border-radius: 10px; border: none; font-weight: bold; cursor: pointer; display: flex; align-items: center; justify-content: center; gap: 5px; }
        .btn-expense { background: #333; color: var(--danger); border: 1px solid var(--danger); }

        /* MODALS */
        .modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.95); z-index: 6000; align-items: center; justify-content: center; backdrop-filter: blur(5px); }
        .modal-content { background: #1a1a1a; padding: 25px; border-radius: 20px; width: 90%; max-width: 400px; border: 1px solid #444; position: relative; }
        .close-modal { position: absolute; top: 15px; right: 15px; font-size: 20px; color: #666; cursor: pointer; }
        
        /* BOTTOM BAR */
        .bottom-bar { position: fixed; bottom: 0; left: 0; width: 100%; background: #1a1a1a; padding: 15px; display: flex; justify-content: space-around; border-top: 1px solid #333; z-index: 4000; }
        .nav-btn { background: none; border: none; color: #666; font-size: 24px; cursor: pointer; display: flex; flex-direction: column; align-items: center; font-size: 10px; gap: 5px; }
        .nav-btn i { font-size: 20px; margin-bottom: 2px; }
        .nav-btn.active { color: var(--primary); }

        .btn-admin { width: 100%; padding: 12px; background: #333; border: 1px solid #555; color: white; border-radius: 8px; margin-top: 10px; cursor: pointer; }
    </style>
</head>
<body>

    <!-- LOADER -->
    <div id="loader">
        <div class="spinner"></div>
        <p style="margin-top:10px; font-size:12px; color:#666;">Connexion S√©curis√©e...</p>
    </div>

    <!-- 1. LOGIN SCREEN -->
    <div id="login-screen">
        <div class="login-box">
            <h1 style="color:var(--primary); margin-bottom:5px;"><i class="fa-solid fa-champagne-glasses"></i> MAQUIS CLOUD</h1>
            <p style="color:#666; font-size:12px; margin-bottom:20px;">Gestion Compl√®te V2</p>
            
            <input type="email" id="email" class="login-input" placeholder="Email du G√©rant">
            <input type="password" id="password" class="login-input" placeholder="Mot de passe">
            
            <button class="btn-auth" onclick="login()">SE CONNECTER</button>
            <button class="btn-auth" onclick="register()" style="background:#222; border:1px solid #444; color:#aaa; margin-top:15px;">Cr√©er un nouveau compte</button>
            <p id="auth-msg" style="color:var(--danger); margin-top:15px; font-size:12px;"></p>
        </div>
    </div>

    <!-- 2. APP PRINCIPALE -->
    <div id="app-container">
        <header>
            <div class="brand">MAQUIS<span style="color:white">MANAGER</span></div>
            <button class="logout-btn" onclick="logout()"><i class="fa-solid fa-power-off"></i></button>
        </header>

        <!-- DASHBOARD TAB -->
        <div id="tab-home">
            
            <!-- STATS GRID -->
            <div class="dashboard-grid">
                <div class="stat-card main">
                    <h3>Net en Caisse (R√©el)</h3>
                    <div class="val" id="net-display">0 FCFA</div>
                </div>
                <div class="stat-card">
                    <h3 style="color:var(--success)">Ventes</h3>
                    <div class="val" id="ca-display" style="font-size:18px;">0</div>
                </div>
                <div class="stat-card">
                    <h3 style="color:var(--danger)">D√©penses</h3>
                    <div class="val" id="expense-display" style="font-size:18px;">0</div>
                </div>
            </div>

            <!-- ACTION BAR -->
            <div class="action-bar">
                <button class="btn-action btn-expense" onclick="openModal('modal-expense')">
                    <i class="fa-solid fa-money-bill-transfer"></i> Sortie Caisse
                </button>
            </div>

            <h3 style="color:#aaa; font-size:12px; margin-bottom:10px; text-transform:uppercase;">Vente Rapide</h3>
            <div id="products-list">
                <p style="text-align:center; color:#666; padding:20px;">Chargement...</p>
            </div>

            <!-- LOGS -->
            <div class="log-section">
                <h4 style="margin:0 0 10px 0; font-size:12px; color:#aaa;">HISTORIQUE R√âCENT</h4>
                <div id="logs-list">
                    <!-- Logs here -->
                </div>
            </div>
        </div>

        <!-- ADMIN TAB (Cach√© par d√©faut) -->
        <div id="tab-admin" style="display:none;">
            <h2 style="color:var(--primary)">‚öôÔ∏è Gestion Stock & Admin</h2>
            
            <div style="background:#222; padding:15px; border-radius:10px; margin-bottom:20px;">
                <h4 style="margin:0 0 10px 0;">Ajouter un Produit</h4>
                <input type="text" id="new-prod-name" placeholder="Nom (ex: Bock)" class="login-input" style="padding:10px;">
                <input type="number" id="new-prod-price" placeholder="Prix (ex: 1000)" class="login-input" style="padding:10px;">
                <input type="number" id="new-prod-stock" placeholder="Stock Initial" class="login-input" style="padding:10px;">
                <button class="btn-admin" style="background:var(--success); border:none;" onclick="addProduct()">AJOUTER</button>
            </div>

            <h4 style="color:#aaa;">Actions Sensibles</h4>
            <button class="btn-admin" onclick="openModal('modal-restock')" style="background:#334; border:1px solid #556;">üì¶ R√©approvisionner Stock</button>
            <button class="btn-admin" onclick="resetDay()" style="background:var(--danger); border:none; margin-top:20px;">üî¥ CL√îTURER LA JOURN√âE (RAZ)</button>
        </div>
    </div>

    <!-- MODAL EXPENSE -->
    <div id="modal-expense" class="modal">
        <div class="modal-content">
            <i class="close-modal fa-solid fa-xmark" onclick="closeModal('modal-expense')"></i>
            <h3 style="color:var(--danger)">üí∏ Sortie de Caisse</h3>
            <input type="text" id="exp-reason" class="login-input" placeholder="Motif (ex: Glace, Transport)">
            <input type="number" id="exp-amount" class="login-input" placeholder="Montant (FCFA)">
            <button class="btn-auth" style="background:var(--danger); color:white;" onclick="addExpense()">VALIDER LA SORTIE</button>
        </div>
    </div>

    <!-- MODAL RESTOCK -->
    <div id="modal-restock" class="modal">
        <div class="modal-content">
            <i class="close-modal fa-solid fa-xmark" onclick="closeModal('modal-restock')"></i>
            <h3 style="color:var(--info)">üì¶ R√©approvisionnement</h3>
            <p style="font-size:12px; color:#aaa;">Ajouter du stock √† un produit existant.</p>
            
            <select id="restock-select" class="login-input" style="background:#333;">
                <!-- Options filled by JS -->
            </select>
            <input type="number" id="restock-amount" class="login-input" placeholder="Quantit√© √† ajouter (ex: 24)">
            <button class="btn-auth" style="background:var(--info); color:white;" onclick="restockProduct()">AJOUTER AU STOCK</button>
        </div>
    </div>

    <!-- NAVIGATION BASSE -->
    <div class="bottom-bar" id="bottom-nav" style="display:none;">
        <button class="nav-btn active" onclick="switchTab('home')">
            <i class="fa-solid fa-cash-register"></i> Caisse
        </button>
        <button class="nav-btn" onclick="switchTab('admin')">
            <i class="fa-solid fa-gear"></i> Gestion
        </button>
        <button class="nav-btn" onclick="sendReport()">
            <i class="fa-brands fa-whatsapp"></i> Rapport
        </button>
    </div>

    <!-- FIREBASE LOGIC -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getAnalytics } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-analytics.js";
        import { getAuth, createUserWithEmailAndPassword, signInWithEmailAndPassword, onAuthStateChanged, signOut } 
        from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
        import { getFirestore, doc, setDoc, updateDoc, onSnapshot, arrayUnion, getDoc } 
        from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        // CONFIG ORIGINALE (NE PAS TOUCHER)
        const firebaseConfig = {
          apiKey: "AIzaSyCb22QgS99n6gzYmcCJoPzsVwd1uwg9g7k",
          authDomain: "maquismanager.firebaseapp.com",
          projectId: "maquismanager",
          storageBucket: "maquismanager.firebasestorage.app",
          messagingSenderId: "565292456302",
          appId: "1:565292456302:web:ef737768b5e0f06a05897f",
          measurementId: "G-MWWLQJK1SL"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        let currentUser = null;
        let currentData = null;

        // AUTH
        window.register = async () => {
            const e = document.getElementById('email').value;
            const p = document.getElementById('password').value;
            if(p.length < 6) { alert("Le mot de passe doit faire 6 caract√®res minimum"); return; }
            
            showLoader(true);
            try {
                await createUserWithEmailAndPassword(auth, e, p).then(cred => {
                    setDoc(doc(db, "maquis", cred.user.uid), {
                        ca_day: 0,
                        expense_day: 0,
                        products: [
                            { id: 1, name: "Bock 66", price: 1000, stock: 24 },
                            { id: 2, name: "Ivoire", price: 1100, stock: 24 }
                        ],
                        logs: []
                    });
                });
                alert("Compte cr√©√© !");
            } catch (error) {
                alert("Erreur: " + error.message);
                showLoader(false);
            }
        };

        window.login = async () => {
            const e = document.getElementById('email').value;
            const p = document.getElementById('password').value;
            showLoader(true);
            try {
                await signInWithEmailAndPassword(auth, e, p);
            } catch (error) {
                document.getElementById('auth-msg').innerText = "Erreur connexion.";
                showLoader(false);
            }
        };

        window.logout = () => signOut(auth);

        onAuthStateChanged(auth, (user) => {
            showLoader(false);
            if (user) {
                currentUser = user;
                document.getElementById('login-screen').style.display = 'none';
                document.getElementById('app-container').style.display = 'block';
                document.getElementById('bottom-nav').style.display = 'flex';
                initRealTimeData();
            } else {
                currentUser = null;
                document.getElementById('login-screen').style.display = 'flex';
                document.getElementById('app-container').style.display = 'none';
                document.getElementById('bottom-nav').style.display = 'none';
            }
        });

        // DATA SYNC
        function initRealTimeData() {
            onSnapshot(doc(db, "maquis", currentUser.uid), (docSnap) => {
                if(docSnap.exists()) {
                    currentData = docSnap.data();
                    renderUI(currentData);
                    updateRestockSelect(currentData.products);
                }
            });
        }

        function renderUI(data) {
            let ca = data.ca_day || 0;
            let exp = data.expense_day || 0;
            let net = ca - exp;

            document.getElementById('ca-display').innerText = ca.toLocaleString();
            document.getElementById('expense-display').innerText = exp.toLocaleString();
            document.getElementById('net-display').innerText = net.toLocaleString() + " F";

            // Products
            const list = document.getElementById('products-list');
            list.innerHTML = '';
            if(data.products && data.products.length > 0) {
                data.products.forEach((p, index) => {
                    let html = `
                    <div class="product-item">
                        <div class="p-info">
                            <span class="p-name">${p.name}</span>
                            <span class="p-price">${p.price} F</span>
                        </div>
                        <div class="p-actions">
                            <span class="stock-badge">Stock: ${p.stock}</span>
                            <button class="btn-sell" onclick="sellProduct(${index})">VENDRE</button>
                        </div>
                    </div>`;
                    list.innerHTML += html;
                });
            } else {
                list.innerHTML = '<p style="text-align:center; color:#666;">Aucun produit.</p>';
            }

            // Logs
            const logsList = document.getElementById('logs-list');
            logsList.innerHTML = '';
            if(data.logs && data.logs.length > 0) {
                // Show last 5 logs reversed
                let recentLogs = data.logs.slice(-5).reverse();
                recentLogs.forEach(log => {
                    let color = log.type === 'expense' ? '#FF4444' : (log.type === 'restock' ? '#33b5e5' : '#00C851');
                    logsList.innerHTML += `
                    <div class="log-item">
                        <span style="color:${color}">${log.desc}</span>
                        <span class="log-time">${log.time}</span>
                    </div>`;
                });
            } else {
                logsList.innerHTML = '<div style="text-align:center; padding:10px; color:#444;">Aucune activit√© r√©cente</div>';
            }
        }

        function updateRestockSelect(products) {
            const select = document.getElementById('restock-select');
            select.innerHTML = '';
            if(products) {
                products.forEach((p, index) => {
                    let opt = document.createElement('option');
                    opt.value = index;
                    opt.innerHTML = p.name;
                    select.appendChild(opt);
                });
            }
        }

        // ACTIONS
        window.sellProduct = async (index) => {
            if(!currentData) return;
            let p = currentData.products[index];
            if(p.stock > 0) {
                let newProducts = [...currentData.products];
                newProducts[index].stock--;
                
                let log = { type: 'sale', desc: `Vente: ${p.name}`, time: new Date().toLocaleTimeString() };
                
                await updateDoc(doc(db, "maquis", currentUser.uid), {
                    products: newProducts,
                    ca_day: (currentData.ca_day || 0) + parseInt(p.price),
                    logs: arrayUnion(log)
                });
                if(navigator.vibrate) navigator.vibrate(50);
            } else { alert("Stock √âpuis√© !"); }
        };

        window.addExpense = async () => {
            const reason = document.getElementById('exp-reason').value;
            const amount = parseInt(document.getElementById('exp-amount').value);
            
            if(reason && amount) {
                let log = { type: 'expense', desc: `Sortie: ${amount}F (${reason})`, time: new Date().toLocaleTimeString() };
                await updateDoc(doc(db, "maquis", currentUser.uid), {
                    expense_day: (currentData.expense_day || 0) + amount,
                    logs: arrayUnion(log)
                });
                closeModal('modal-expense');
                document.getElementById('exp-reason').value = "";
                document.getElementById('exp-amount').value = "";
            }
        };

        window.restockProduct = async () => {
            const index = document.getElementById('restock-select').value;
            const amount = parseInt(document.getElementById('restock-amount').value);
            
            if(index !== "" && amount) {
                let newProducts = [...currentData.products];
                newProducts[index].stock += amount;
                
                let log = { type: 'restock', desc: `Ajout Stock: +${amount} ${newProducts[index].name}`, time: new Date().toLocaleTimeString() };
                
                await updateDoc(doc(db, "maquis", currentUser.uid), {
                    products: newProducts,
                    logs: arrayUnion(log)
                });
                closeModal('modal-restock');
                document.getElementById('restock-amount').value = "";
                alert("Stock mis √† jour !");
            }
        };

        window.addProduct = async () => {
            const name = document.getElementById('new-prod-name').value;
            const price = parseInt(document.getElementById('new-prod-price').value);
            const stock = parseInt(document.getElementById('new-prod-stock').value);

            if(name && price && stock) {
                let newProd = { id: Date.now(), name, price, stock };
                let newList = currentData.products ? [...currentData.products, newProd] : [newProd];
                await updateDoc(doc(db, "maquis", currentUser.uid), { products: newList });
                alert("Produit ajout√© !");
                document.getElementById('new-prod-name').value = "";
                document.getElementById('new-prod-price').value = "";
                document.getElementById('new-prod-stock').value = "";
            }
        };

        window.resetDay = async () => {
            if(confirm("‚ö†Ô∏è CL√îTURER LA CAISSE ?\nCeci remet les compteurs √† z√©ro.")) {
                await updateDoc(doc(db, "maquis", currentUser.uid), {
                    ca_day: 0,
                    expense_day: 0,
                    logs: [] // On vide les logs ou on les garde, au choix. Ici on vide pour le lendemain.
                });
                alert("Journ√©e cl√¥tur√©e !");
            }
        };

        // UI HELPERS
        window.openModal = (id) => document.getElementById(id).style.display = 'flex';
        window.closeModal = (id) => document.getElementById(id).style.display = 'none';
        
        window.switchTab = (tabName) => {
            document.getElementById('tab-home').style.display = tabName === 'home' ? 'block' : 'none';
            document.getElementById('tab-admin').style.display = tabName === 'admin' ? 'block' : 'none';
            document.querySelectorAll('.nav-btn').forEach(btn => btn.classList.remove('active'));
            event.currentTarget.classList.add('active');
        };

        window.sendReport = () => {
            if(!currentData) return;
            let d = new Date();
            let msg = `*üìä RAPPORT COMPLET - ${d.toLocaleDateString()}* %0a`;
            msg += `------------------%0a`;
            msg += `‚úÖ Ventes: ${currentData.ca_day} F %0a`;
            msg += `üîª D√©penses: -${currentData.expense_day || 0} F %0a`;
            msg += `üí∞ *NET CAISSE : ${(currentData.ca_day - (currentData.expense_day || 0))} F* %0a`;
            msg += `------------------%0a`;
            msg += `üì¶ STOCK ACTUEL : %0a`;
            currentData.products.forEach(p => {
                msg += `- ${p.name} : ${p.stock} %0a`;
            });
            window.open(`https://wa.me/?text=${msg}`, '_blank');
        };

        function showLoader(show) {
            document.getElementById('loader').style.opacity = show ? '1' : '0';
            setTimeout(() => {
                document.getElementById('loader').style.display = show ? 'flex' : 'none';
            }, 500);
        }
    </script>
</body>
</html>

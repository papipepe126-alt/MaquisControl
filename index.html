<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Maquis Manager Cloud V3 ☁️ Premium</title>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        :root { 
            --bg: #0a0a0a; 
            --card: #1a1a1a; 
            --card-hover: #222; 
            --primary: #FFD700; 
            --primary-dark: #ccac00; 
            --danger: #FF4444; 
            --success: #00C851; 
            --info: #33b5e5; 
            --text: #fff;
            --text-secondary: #aaa;
            --accent: #FFD70020;
            --shadow: 0 10px 30px rgba(0, 0, 0, 0.5);
            --shadow-light: 0 5px 15px rgba(0, 0, 0, 0.3);
            --gradient: linear-gradient(135deg, #1a1a1a, #0a0a0a);
            --gradient-primary: linear-gradient(135deg, #FFD700, #ccac00);
            --transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }
        
        * { 
            box-sizing: border-box; 
            -webkit-tap-highlight-color: transparent; 
            outline: none; 
        }
        
        body { 
            background: var(--bg); 
            color: var(--text); 
            font-family: 'Poppins', sans-serif; 
            margin: 0; 
            padding: 0;
            overflow-x: hidden;
        }

        /* LOADING SPINNER */
        #loader { 
            position: fixed; 
            top: 0; 
            left: 0; 
            width: 100%; 
            height: 100%; 
            background: var(--bg); 
            z-index: 10000; 
            display: flex; 
            flex-direction: column; 
            align-items: center; 
            justify-content: center; 
            transition: opacity 0.5s ease;
        }
        
        .spinner { 
            border: 4px solid rgba(255, 215, 0, 0.2); 
            border-top: 4px solid var(--primary); 
            border-radius: 50%; 
            width: 50px; 
            height: 50px; 
            animation: spin 1s linear infinite; 
        }
        
        @keyframes spin { 
            0% { transform: rotate(0deg); } 
            100% { transform: rotate(360deg); } 
        }

        /* NOTIFICATION TOAST */
        .toast {
            position: fixed;
            bottom: 100px;
            left: 50%;
            transform: translateX(-50%);
            background: var(--card);
            color: var(--text);
            padding: 15px 25px;
            border-radius: 50px;
            box-shadow: var(--shadow);
            z-index: 5000;
            opacity: 0;
            transition: opacity 0.3s ease, transform 0.3s ease;
            max-width: 80%;
            text-align: center;
            border-left: 4px solid var(--success);
        }
        
        .toast.show {
            opacity: 1;
            transform: translateX(-50%) translateY(-10px);
        }
        
        .toast.error {
            border-left-color: var(--danger);
        }
        
        .toast.info {
            border-left-color: var(--info);
        }

        /* LOGIN SCREEN */
        #login-screen { 
            position: fixed; 
            top: 0; 
            left: 0; 
            width: 100%; 
            height: 100%; 
            background: var(--gradient); 
            z-index: 5000; 
            display: flex; 
            flex-direction: column; 
            align-items: center; 
            justify-content: center; 
            padding: 20px; 
        }
        
        .login-container {
            width: 100%;
            max-width: 450px;
            display: flex;
            flex-direction: column;
            align-items: center;
        }
        
        .login-box { 
            width: 100%; 
            text-align: center; 
            background: rgba(26, 26, 26, 0.8);
            padding: 40px;
            border-radius: 20px;
            box-shadow: var(--shadow);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 215, 0, 0.1);
        }
        
        .login-logo {
            font-size: 40px;
            color: var(--primary);
            margin-bottom: 10px;
        }
        
        .login-title {
            font-size: 24px;
            font-weight: 700;
            color: var(--primary);
            margin-bottom: 5px;
        }
        
        .login-subtitle {
            color: var(--text-secondary);
            font-size: 14px;
            margin-bottom: 30px;
        }
        
        .login-input { 
            width: 100%; 
            padding: 18px; 
            margin: 10px 0; 
            border-radius: 12px; 
            border: 1px solid rgba(255, 215, 0, 0.2); 
            background: rgba(34, 34, 34, 0.7); 
            color: white; 
            font-size: 16px;
            transition: var(--transition);
        }
        
        .login-input:focus {
            border-color: var(--primary);
            background: rgba(34, 34, 34, 0.9);
            box-shadow: 0 0 0 3px rgba(255, 215, 0, 0.1);
        }
        
        .btn-auth { 
            width: 100%; 
            padding: 18px; 
            background: var(--gradient-primary); 
            color: black; 
            font-weight: 600; 
            border: none; 
            border-radius: 12px; 
            cursor: pointer; 
            margin-top: 15px; 
            font-size: 16px;
            transition: var(--transition);
            box-shadow: 0 5px 15px rgba(255, 215, 0, 0.3);
        }
        
        .btn-auth:hover {
            transform: translateY(-3px);
            box-shadow: 0 8px 20px rgba(255, 215, 0, 0.4);
        }
        
        .btn-auth:active {
            transform: translateY(-1px);
        }
        
        .btn-secondary {
            background: transparent;
            border: 1px solid rgba(255, 215, 0, 0.3);
            color: var(--primary);
            box-shadow: none;
        }
        
        .btn-secondary:hover {
            background: rgba(255, 215, 0, 0.1);
        }

        /* APP CONTAINER */
        #app-container { 
            display: none; 
            padding: 20px; 
            padding-bottom: 100px; 
            max-width: 1200px; 
            margin: 0 auto; 
        }
        
        /* HEADER */
        header { 
            display: flex; 
            justify-content: space-between; 
            align-items: center; 
            margin-bottom: 30px; 
            padding: 15px 20px;
            background: var(--card);
            border-radius: 15px;
            box-shadow: var(--shadow-light);
        }
        
        .brand { 
            font-size: 24px; 
            font-weight: 700; 
            color: var(--primary); 
            letter-spacing: 1px;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .user-info {
            display: flex;
            align-items: center;
            gap: 15px;
        }
        
        .user-role {
            background: rgba(255, 215, 0, 0.2);
            color: var(--primary);
            padding: 5px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
        }
        
        .logout-btn { 
            background: var(--card-hover); 
            color: var(--danger); 
            border: 1px solid var(--danger);
            padding: 8px 15px; 
            border-radius: 8px; 
            font-size: 14px; 
            cursor: pointer;
            transition: var(--transition);
            display: flex;
            align-items: center;
            gap: 5px;
        }
        
        .logout-btn:hover {
            background: rgba(255, 68, 68, 0.2);
        }

        /* TAB NAVIGATION */
        .tab-nav {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            overflow-x: auto;
            padding-bottom: 5px;
        }
        
        .tab-btn {
            background: var(--card);
            border: none;
            color: var(--text-secondary);
            padding: 12px 20px;
            border-radius: 10px;
            cursor: pointer;
            font-weight: 500;
            transition: var(--transition);
            white-space: nowrap;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .tab-btn.active {
            background: var(--gradient-primary);
            color: black;
        }
        
        .tab-btn:hover:not(.active) {
            background: var(--card-hover);
            color: var(--text);
        }
        
        .tab-content {
            display: none;
        }
        
        .tab-content.active {
            display: block;
        }

        /* DASHBOARD GRID */
        .dashboard-grid { 
            display: grid; 
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); 
            gap: 20px; 
            margin-bottom: 30px; 
        }
        
        .stat-card { 
            background: var(--card); 
            padding: 25px; 
            border-radius: 20px; 
            text-align: center; 
            border: 1px solid rgba(255, 215, 0, 0.1); 
            transition: var(--transition);
            box-shadow: var(--shadow-light);
            position: relative;
            overflow: hidden;
        }
        
        .stat-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 5px;
            background: var(--gradient-primary);
        }
        
        .stat-card:hover {
            transform: translateY(-5px);
            box-shadow: var(--shadow);
        }
        
        .stat-card.main { 
            grid-column: span 2; 
            background: var(--gradient); 
            border: 1px solid rgba(255, 215, 0, 0.2); 
        }
        
        .stat-card-icon {
            font-size: 24px;
            margin-bottom: 10px;
            color: var(--primary);
        }
        
        .stat-card h3 { 
            margin: 0 0 10px 0; 
            font-size: 14px; 
            color: var(--text-secondary); 
            text-transform: uppercase; 
            font-weight: 500;
        }
        
        .stat-card .val { 
            font-size: 32px; 
            font-weight: 700; 
            margin: 10px 0; 
            color: var(--text); 
        }
        
        .stat-card.main .val { 
            font-size: 42px; 
            color: var(--primary); 
        }
        
        .stat-card .change {
            font-size: 14px;
            margin-top: 5px;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 5px;
        }
        
        .stat-card .change.positive {
            color: var(--success);
        }
        
        .stat-card .change.negative {
            color: var(--danger);
        }

        /* CHART CONTAINER */
        .chart-container {
            background: var(--card);
            padding: 25px;
            border-radius: 20px;
            margin-bottom: 30px;
            box-shadow: var(--shadow-light);
        }
        
        .chart-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }
        
        .chart-title {
            font-size: 18px;
            font-weight: 600;
            color: var(--text);
        }
        
        .chart-options {
            display: flex;
            gap: 10px;
        }
        
        .chart-option {
            background: var(--card-hover);
            border: none;
            color: var(--text-secondary);
            padding: 8px 15px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
            transition: var(--transition);
        }
        
        .chart-option.active {
            background: var(--gradient-primary);
            color: black;
        }
        
        .chart-wrapper {
            position: relative;
            height: 300px;
        }

        /* PRODUCT LIST */
        .section-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }
        
        .section-title {
            font-size: 18px;
            font-weight: 600;
            color: var(--text);
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .btn-add {
            background: var(--gradient-primary);
            color: black;
            border: none;
            padding: 10px 15px;
            border-radius: 10px;
            cursor: pointer;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 5px;
            transition: var(--transition);
        }
        
        .btn-add:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(255, 215, 0, 0.3);
        }
        
        .search-container {
            margin-bottom: 20px;
            position: relative;
        }
        
        .search-input {
            width: 100%;
            padding: 15px 50px 15px 20px;
            border-radius: 15px;
            border: 1px solid rgba(255, 215, 0, 0.2);
            background: var(--card);
            color: var(--text);
            font-size: 16px;
            transition: var(--transition);
        }
        
        .search-input:focus {
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(255, 215, 0, 0.1);
        }
        
        .search-icon {
            position: absolute;
            right: 20px;
            top: 50%;
            transform: translateY(-50%);
            color: var(--text-secondary);
        }
        
        .product-list {
            display: grid;
            gap: 15px;
        }
        
        .product-item { 
            display: flex; 
            justify-content: space-between; 
            align-items: center; 
            background: var(--card); 
            padding: 20px; 
            border-radius: 15px; 
            border: 1px solid rgba(255, 215, 0, 0.1);
            transition: var(--transition);
            box-shadow: var(--shadow-light);
        }
        
        .product-item:hover {
            border-color: var(--primary);
            transform: translateX(5px);
        }
        
        .product-info {
            display: flex;
            align-items: center;
            gap: 15px;
        }
        
        .product-icon {
            width: 50px;
            height: 50px;
            background: var(--gradient-primary);
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 20px;
            color: black;
        }
        
        .product-details {
            display: flex;
            flex-direction: column;
        }
        
        .product-name { 
            font-weight: 600; 
            font-size: 18px; 
            margin-bottom: 5px;
        }
        
        .product-price { 
            color: var(--success); 
            font-size: 16px; 
            font-weight: 500;
        }
        
        .product-actions { 
            display: flex; 
            align-items: center; 
            gap: 15px; 
        }
        
        .stock-badge { 
            background: var(--card-hover); 
            padding: 8px 15px; 
            border-radius: 10px; 
            font-size: 14px; 
            color: var(--text-secondary);
            display: flex;
            align-items: center;
            gap: 5px;
        }
        
        .stock-badge.low {
            background: rgba(255, 68, 68, 0.2);
            color: var(--danger);
        }
        
        .product-buttons {
            display: flex;
            gap: 10px;
        }
        
        .btn-sell { 
            background: var(--success); 
            color: white; 
            border: none; 
            padding: 10px 15px; 
            border-radius: 10px; 
            font-weight: 600; 
            cursor: pointer;
            transition: var(--transition);
            display: flex;
            align-items: center;
            gap: 5px;
        }
        
        .btn-sell:hover {
            background: #00a846;
            transform: translateY(-2px);
        }
        
        .btn-edit {
            background: var(--info);
            color: white;
            border: none;
            padding: 10px;
            border-radius: 10px;
            cursor: pointer;
            transition: var(--transition);
        }
        
        .btn-edit:hover {
            background: #209dd5;
        }
        
        .btn-delete {
            background: var(--danger);
            color: white;
            border: none;
            padding: 10px;
            border-radius: 10px;
            cursor: pointer;
            transition: var(--transition);
        }
        
        .btn-delete:hover {
            background: #dd3333;
        }

        /* LOGS SECTION */
        .log-section { 
            margin-top: 30px; 
            background: var(--card); 
            padding: 25px; 
            border-radius: 20px; 
            box-shadow: var(--shadow-light);
        }
        
        .log-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }
        
        .log-title {
            font-size: 18px;
            font-weight: 600;
            color: var(--text);
        }
        
        .log-filter {
            display: flex;
            gap: 10px;
        }
        
        .log-filter-btn {
            background: var(--card-hover);
            border: none;
            color: var(--text-secondary);
            padding: 8px 15px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
            transition: var(--transition);
        }
        
        .log-filter-btn.active {
            background: var(--gradient-primary);
            color: black;
        }
        
        .log-list {
            max-height: 400px;
            overflow-y: auto;
        }
        
        .log-item { 
            display: flex; 
            justify-content: space-between; 
            font-size: 14px; 
            padding: 15px 0; 
            border-bottom: 1px solid rgba(255, 215, 0, 0.1); 
            color: var(--text-secondary);
            transition: var(--transition);
        }
        
        .log-item:hover {
            color: var(--text);
            padding-left: 10px;
        }
        
        .log-item:last-child { 
            border-bottom: none; 
        }
        
        .log-content {
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .log-icon {
            width: 36px;
            height: 36px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .log-icon.sale {
            background: rgba(0, 200, 81, 0.2);
            color: var(--success);
        }
        
        .log-icon.expense {
            background: rgba(255, 68, 68, 0.2);
            color: var(--danger);
        }
        
        .log-icon.restock {
            background: rgba(51, 181, 229, 0.2);
            color: var(--info);
        }
        
        .log-details {
            display: flex;
            flex-direction: column;
        }
        
        .log-desc {
            color: var(--text);
            margin-bottom: 3px;
        }
        
        .log-time { 
            color: var(--text-secondary); 
            font-size: 12px; 
        }
        
        .log-amount {
            font-weight: 600;
        }

        /* MODALS */
        .modal { 
            display: none; 
            position: fixed; 
            top: 0; 
            left: 0; 
            width: 100%; 
            height: 100%; 
            background: rgba(0,0,0,0.8); 
            z-index: 6000; 
            align-items: center; 
            justify-content: center; 
            backdrop-filter: blur(5px);
            padding: 20px;
        }
        
        .modal-content { 
            background: var(--card); 
            padding: 30px; 
            border-radius: 20px; 
            width: 100%; 
            max-width: 500px; 
            border: 1px solid rgba(255, 215, 0, 0.2); 
            position: relative;
            animation: modalSlideIn 0.3s ease;
            box-shadow: var(--shadow);
        }
        
        @keyframes modalSlideIn {
            from {
                transform: translateY(-50px);
                opacity: 0;
            }
            to {
                transform: translateY(0);
                opacity: 1;
            }
        }
        
        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 25px;
        }
        
        .modal-title {
            font-size: 20px;
            font-weight: 600;
            color: var(--text);
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .close-modal { 
            font-size: 24px; 
            color: var(--text-secondary); 
            cursor: pointer; 
            transition: var(--transition); 
            background: none; 
            border: none; 
        }
        
        .close-modal:hover {
            color: var(--danger);
        }
        
        .form-group {
            margin-bottom: 20px;
        }
        
        .form-label {
            display: block;
            margin-bottom: 8px;
            font-size: 14px;
            font-weight: 500;
            color: var(--text-secondary);
        }
        
        .form-input, .form-select {
            width: 100%;
            padding: 15px;
            border-radius: 10px;
            border: 1px solid rgba(255, 215, 0, 0.2);
            background: var(--card-hover);
            color: var(--text);
            font-size: 16px;
            transition: var(--transition);
        }
        
        .form-input:focus, .form-select:focus {
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(255, 215, 0, 0.1);
        }
        
        .form-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
        }
        
        .modal-footer {
            display: flex;
            justify-content: flex-end;
            gap: 10px;
            margin-top: 25px;
        }
        
        .btn-cancel {
            background: var(--card-hover);
            color: var(--text);
            border: 1px solid rgba(255, 215, 0, 0.2);
            padding: 12px 20px;
            border-radius: 10px;
            cursor: pointer;
            font-weight: 500;
            transition: var(--transition);
        }
        
        .btn-cancel:hover {
            background: rgba(255, 215, 0, 0.1);
        }
        
        .btn-submit {
            background: var(--gradient-primary);
            color: black;
            border: none;
            padding: 12px 20px;
            border-radius: 10px;
            cursor: pointer;
            font-weight: 600;
            transition: var(--transition);
        }
        
        .btn-submit:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(255, 215, 0, 0.3);
        }

        /* BOTTOM BAR */
        .bottom-bar { 
            position: fixed; 
            bottom: 0; 
            left: 0; 
            width: 100%; 
            background: var(--card); 
            padding: 15px 20px; 
            display: flex; 
            justify-content: space-around; 
            border-top: 1px solid rgba(255, 215, 0, 0.1); 
            z-index: 4000;
            box-shadow: 0 -5px 15px rgba(0, 0, 0, 0.3);
        }
        
        .nav-btn { 
            background: none; 
            border: none; 
            color: var(--text-secondary); 
            cursor: pointer; 
            display: flex; 
            flex-direction: column; 
            align-items: center; 
            font-size: 12px; 
            gap: 5px;
            transition: var(--transition);
            padding: 5px 10px;
            border-radius: 10px;
        }
        
        .nav-btn i { 
            font-size: 20px; 
        }
        
        .nav-btn.active { 
            color: var(--primary); 
        }
        
        .nav-btn:hover {
            color: var(--primary);
            background: rgba(255, 215, 0, 0.1);
        }

        /* ADMIN SECTION */
        .admin-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        
        .admin-card {
            background: var(--card);
            padding: 25px;
            border-radius: 20px;
            box-shadow: var(--shadow-light);
            border: 1px solid rgba(255, 215, 0, 0.1);
        }
        
        .admin-card-title {
            font-size: 18px;
            font-weight: 600;
            color: var(--text);
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .employee-list {
            display: grid;
            gap: 15px;
        }
        
        .employee-item {
            display: flex;
            align-items: center;
            gap: 15px;
            padding: 15px;
            background: var(--card-hover);
            border-radius: 12px;
            transition: var(--transition);
        }
        
        .employee-item:hover {
            background: rgba(255, 215, 0, 0.1);
        }
        
        .employee-avatar {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            background: var(--gradient-primary);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 20px;
            color: black;
            font-weight: 600;
        }
        
        .employee-info {
            flex: 1;
        }
        
        .employee-name {
            font-weight: 600;
            margin-bottom: 3px;
        }
        
        .employee-role {
            font-size: 14px;
            color: var(--text-secondary);
        }
        
        .employee-actions {
            display: flex;
            gap: 10px;
        }
        
        .btn-employee {
            background: none;
            border: none;
            color: var(--text-secondary);
            cursor: pointer;
            font-size: 18px;
            transition: var(--transition);
            padding: 5px;
            border-radius: 5px;
        }
        
        .btn-employee:hover {
            color: var(--primary);
            background: rgba(255, 215, 0, 0.1);
        }
        
        .settings-list {
            display: grid;
            gap: 15px;
        }
        
        .settings-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px;
            background: var(--card-hover);
            border-radius: 12px;
        }
        
        .settings-label {
            font-weight: 500;
        }
        
        .toggle-switch {
            position: relative;
            width: 50px;
            height: 26px;
            background: var(--card);
            border-radius: 13px;
            cursor: pointer;
            transition: var(--transition);
        }
        
        .toggle-switch.active {
            background: var(--gradient-primary);
        }
        
        .toggle-slider {
            position: absolute;
            top: 3px;
            left: 3px;
            width: 20px;
            height: 20px;
            background: white;
            border-radius: 50%;
            transition: var(--transition);
        }
        
        .toggle-switch.active .toggle-slider {
            transform: translateX(24px);
        }
        
        .export-buttons {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 15px;
        }
        
        .btn-export {
            background: var(--card-hover);
            border: 1px solid rgba(255, 215, 0, 0.2);
            color: var(--text);
            padding: 15px;
            border-radius: 12px;
            cursor: pointer;
            font-weight: 500;
            transition: var(--transition);
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 10px;
        }
        
        .btn-export:hover {
            background: rgba(255, 215, 0, 0.1);
            border-color: var(--primary);
        }
        
        .btn-export i {
            font-size: 24px;
            color: var(--primary);
        }

        /* RESPONSIVE */
        @media (max-width: 768px) {
            .dashboard-grid {
                grid-template-columns: 1fr;
            }
            
            .stat-card.main {
                grid-column: span 1;
            }
            
            .form-row {
                grid-template-columns: 1fr;
            }
            
            .admin-grid {
                grid-template-columns: 1fr;
            }
            
            .export-buttons {
                grid-template-columns: 1fr;
            }
            
            .product-actions {
                flex-direction: column;
                gap: 10px;
            }
            
            .product-buttons {
                width: 100%;
                justify-content: space-between;
            }
        }
    </style>
</head>
<body>

    <div id="loader">
        <div class="spinner"></div>
        <p style="margin-top:15px; font-size:14px; color:#666;">Connexion Sécurisée...</p>
    </div>

    <div id="toast" class="toast"></div>

    <div id="login-screen">
        <div class="login-container">
            <div class="login-box">
                <div class="login-logo">
                    <i class="fa-solid fa-champagne-glasses"></i>
                </div>
                <h1 class="login-title">MAQUIS CLOUD</h1>
                <p class="login-subtitle">Gestion Premium V3</p>
                
                <input type="email" id="email" class="login-input" placeholder="Email">
                <input type="password" id="password" class="login-input" placeholder="Mot de passe">
                
                <button class="btn-auth" id="login-btn">SE CONNECTER</button>
                <button class="btn-auth btn-secondary" id="register-btn">Créer un compte</button>
                <p id="auth-msg" style="color:var(--danger); margin-top:15px; font-size:14px;"></p>
            </div>
        </div>
    </div>

    <div id="app-container">
        <header>
            <div class="brand">
                <i class="fa-solid fa-champagne-glasses"></i>
                MAQUIS<span style="color:white">MANAGER</span>
            </div>
            <div class="user-info">
                <div class="user-role" id="user-role">Employé</div>
                <button class="logout-btn" id="logout-btn">
                    <i class="fa-solid fa-power-off"></i> Déconnexion
                </button>
            </div>
        </header>

        <div class="tab-nav">
            <button class="tab-btn active" data-tab="dashboard">
                <i class="fa-solid fa-chart-line"></i> Tableau de bord
            </button>
            <button class="tab-btn" data-tab="sales">
                <i class="fa-solid fa-cash-register"></i> Ventes
            </button>
            <button class="tab-btn" data-tab="products">
                <i class="fa-solid fa-box"></i> Produits
            </button>
            <button class="tab-btn" data-tab="reports">
                <i class="fa-solid fa-file-alt"></i> Rapports
            </button>
            <button class="tab-btn admin-only" data-tab="admin" style="display:none;">
                <i class="fa-solid fa-user-shield"></i> Admin
            </button>
        </div>

        <div class="tab-content active" id="tab-dashboard">
            <div class="dashboard-grid">
                <div class="stat-card main">
                    <div class="stat-card-icon">
                        <i class="fa-solid fa-wallet"></i>
                    </div>
                    <h3>Net en Caisse (Réel)</h3>
                    <div class="val" id="net-display">0 FCFA</div>
                    <div class="change positive">
                        <i class="fa-solid fa-arrow-up"></i> +12% par rapport à hier
                    </div>
                </div>
                <div class="stat-card">
                    <div class="stat-card-icon">
                        <i class="fa-solid fa-chart-line"></i>
                    </div>
                    <h3>Ventes du jour</h3>
                    <div class="val" id="ca-display">0</div>
                    <div class="change positive">
                        <i class="fa-solid fa-arrow-up"></i> +8% par rapport à hier
                    </div>
                </div>
                <div class="stat-card">
                    <div class="stat-card-icon">
                        <i class="fa-solid fa-money-bill-transfer"></i>
                    </div>
                    <h3>Dépenses du jour</h3>
                    <div class="val" id="expense-display">0</div>
                    <div class="change negative">
                        <i class="fa-solid fa-arrow-down"></i> -5% par rapport à hier
                    </div>
                </div>
                <div class="stat-card">
                    <div class="stat-card-icon">
                        <i class="fa-solid fa-shopping-cart"></i>
                    </div>
                    <h3>Ventes totales</h3>
                    <div class="val" id="sales-count">0</div>
                    <div class="change positive">
                        <i class="fa-solid fa-arrow-up"></i> +15% par rapport à hier
                    </div>
                </div>
                <div class="stat-card">
                    <div class="stat-card-icon">
                        <i class="fa-solid fa-box"></i>
                    </div>
                    <h3>Produits en stock</h3>
                    <div class="val" id="stock-count">0</div>
                    <div class="change negative">
                        <i class="fa-solid fa-arrow-down"></i> 3 produits en rupture
                    </div>
                </div>
            </div>

            <div class="chart-container">
                <div class="chart-header">
                    <h3 class="chart-title">Performance mensuelle</h3>
                    <div class="chart-options">
                        <button class="chart-option active" data-chart="revenue">Recettes</button>
                        <button class="chart-option" data-chart="expenses">Dépenses</button>
                        <button class="chart-option" data-chart="profit">Bénéfices</button>
                    </div>
                </div>
                <div class="chart-wrapper">
                    <canvas id="monthly-chart"></canvas>
                </div>
            </div>

            <div class="chart-container">
                <div class="chart-header">
                    <h3 class="chart-title">Ventes par produit</h3>
                    <div class="chart-options">
                        <button class="chart-option active" data-period="week">Semaine</button>
                        <button class="chart-option" data-period="month">Mois</button>
                        <button class="chart-option" data-period="year">Année</button>
                    </div>
                </div>
                <div class="chart-wrapper">
                    <canvas id="product-chart"></canvas>
                </div>
            </div>
        </div>

        <div class="tab-content" id="tab-sales">
            <div class="section-header">
                <h3 class="section-title">
                    <i class="fa-solid fa-cash-register"></i> Ventes rapides
                </h3>
                <button class="btn-add" id="quick-sale-btn">
                    <i class="fa-solid fa-plus"></i> Vente manuelle
                </button>
            </div>
            
            <div class="search-container">
                <input type="text" id="product-search" class="search-input" placeholder="Rechercher un produit...">
                <i class="fa-solid fa-search search-icon"></i>
            </div>
            
            <div class="product-list" id="products-list">
                <p style="text-align:center; color:#666; padding:20px;">Chargement...</p>
            </div>

            <div class="log-section">
                <div class="log-header">
                    <h3 class="log-title">Historique des transactions</h3>
                    <div class="log-filter">
                        <button class="log-filter-btn active" data-filter="all">Toutes</button>
                        <button class="log-filter-btn" data-filter="sales">Ventes</button>
                        <button class="log-filter-btn" data-filter="expenses">Dépenses</button>
                    </div>
                </div>
                <div class="log-list" id="logs-list">
                    </div>
            </div>
        </div>

        <div class="tab-content" id="tab-products">
            <div class="section-header">
                <h3 class="section-title">
                    <i class="fa-solid fa-box"></i> Gestion des produits
                </h3>
                <button class="btn-add" id="add-product-btn">
                    <i class="fa-solid fa-plus"></i> Ajouter un produit
                </button>
            </div>
            
            <div class="search-container">
                <input type="text" id="product-search-admin" class="search-input" placeholder="Rechercher un produit...">
                <i class="fa-solid fa-search search-icon"></i>
            </div>
            
            <div class="product-list" id="products-list-admin">
                <p style="text-align:center; color:#666; padding:20px;">Chargement...</p>
            </div>
        </div>

        <div class="tab-content" id="tab-reports">
            <div class="section-header">
                <h3 class="section-title">
                    <i class="fa-solid fa-file-alt"></i> Rapports et analyses
                </h3>
            </div>
            
            <div class="dashboard-grid">
                <div class="admin-card">
                    <h3 class="admin-card-title">
                        <i class="fa-solid fa-calendar-alt"></i> Rapport quotidien
                    </h3>
                    <p style="color: var(--text-secondary); margin-bottom: 20px;">Générez un rapport détaillé des ventes et dépenses du jour.</p>
                    <button class="btn-auth" id="daily-report-btn" style="width: 100%;">
                        <i class="fa-solid fa-download"></i> Télécharger le rapport
                    </button>
                </div>
                
                <div class="admin-card">
                    <h3 class="admin-card-title">
                        <i class="fa-solid fa-calendar-week"></i> Rapport hebdomadaire
                    </h3>
                    <p style="color: var(--text-secondary); margin-bottom: 20px;">Analysez les performances de la semaine.</p>
                    <button class="btn-auth" id="weekly-report-btn" style="width: 100%;">
                        <i class="fa-solid fa-download"></i> Télécharger le rapport
                    </button>
                </div>
                
                <div class="admin-card">
                    <h3 class="admin-card-title">
                        <i class="fa-solid fa-calendar"></i> Rapport mensuel
                    </h3>
                    <p style="color: var(--text-secondary); margin-bottom: 20px;">Vue d'ensemble complète des performances mensuelles.</p>
                    <button class="btn-auth" id="monthly-report-btn" style="width: 100%;">
                        <i class="fa-solid fa-download"></i> Télécharger le rapport
                    </button>
                </div>
                
                <div class="admin-card">
                    <h3 class="admin-card-title">
                        <i class="fa-solid fa-share"></i> Partager via WhatsApp
                    </h3>
                    <p style="color: var(--text-secondary); margin-bottom: 20px;">Envoyez un résumé des performances directement via WhatsApp.</p>
                    <button class="btn-auth" id="whatsapp-report-btn" style="width: 100%; background: #25D366; color: white;">
                        <i class="fa-brands fa-whatsapp"></i> Envoyer sur WhatsApp
                    </button>
                </div>
            </div>
            
            <div class="chart-container">
                <div class="chart-header">
                    <h3 class="chart-title">Analyse comparative</h3>
                    <div class="chart-options">
                        <button class="chart-option active" data-comparison="months">Mois précédents</button>
                        <button class="chart-option" data-comparison="products">Produits</button>
                    </div>
                </div>
                <div class="chart-wrapper">
                    <canvas id="comparison-chart"></canvas>
                </div>
            </div>
        </div>

        <div class="tab-content" id="tab-admin">
            <div class="section-header">
                <h3 class="section-title">
                    <i class="fa-solid fa-user-shield"></i> Panneau d'administration
                </h3>
            </div>
            
            <div class="admin-grid">
                <div class="admin-card">
                    <h3 class="admin-card-title">
                        <i class="fa-solid fa-users"></i> Gestion des employés
                    </h3>
                    <div class="employee-list" id="employee-list">
                        </div>
                    <button class="btn-auth" id="add-employee-btn" style="width: 100%; margin-top: 20px;">
                        <i class="fa-solid fa-user-plus"></i> Ajouter un employé
                    </button>
                </div>
                
                <div class="admin-card">
                    <h3 class="admin-card-title">
                        <i class="fa-solid fa-cog"></i> Paramètres de l'application
                    </h3>
                    <div class="settings-list">
                        <div class="settings-item">
                            <span class="settings-label">Notifications push</span>
                            <div class="toggle-switch active" id="notification-toggle">
                                <div class="toggle-slider"></div>
                            </div>
                        </div>
                        <div class="settings-item">
                            <span class="settings-label">Sauvegarde automatique</span>
                            <div class="toggle-switch active" id="backup-toggle">
                                <div class="toggle-slider"></div>
                            </div>
                        </div>
                        <div class="settings-item">
                            <span class="settings-label">Rapports quotidiens</span>
                            <div class="toggle-switch" id="daily-report-toggle">
                                <div class="toggle-slider"></div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="admin-card">
                <h3 class="admin-card-title">
                    <i class="fa-solid fa-database"></i> Exportation de données
                </h3>
                <div class="export-buttons">
                    <button class="btn-export" id="export-sales-btn">
                        <i class="fa-solid fa-chart-line"></i>
                        Exporter les ventes
                    </button>
                    <button class="btn-export" id="export-products-btn">
                        <i class="fa-solid fa-box"></i>
                        Exporter les produits
                    </button>
                    <button class="btn-export" id="export-logs-btn">
                        <i class="fa-solid fa-history"></i>
                        Exporter l'historique
                    </button>
                    <button class="btn-export" id="export-all-btn">
                        <i class="fa-solid fa-database"></i>
                        Exporter tout
                    </button>
                </div>
            </div>
            
            <div class="admin-card" style="margin-top: 20px;">
                <h3 class="admin-card-title">
                    <i class="fa-solid fa-sync"></i> Synchronisation et sauvegarde
                </h3>
                <p style="color: var(--text-secondary); margin-bottom: 20px;">Dernière sauvegarde: <span id="last-backup">Il y a 2 heures</span></p>
                <button class="btn-auth" id="backup-now-btn" style="width: 100%;">
                    <i class="fa-solid fa-cloud-upload-alt"></i> Sauvegarder maintenant
                </button>
            </div>
        </div>
    </div>

    <div class="bottom-bar" id="bottom-nav" style="display:none;">
        <button class="nav-btn active" data-nav="dashboard">
            <i class="fa-solid fa-chart-line"></i> Tableau
        </button>
        <button class="nav-btn" data-nav="sales">
            <i class="fa-solid fa-cash-register"></i> Ventes
        </button>
        <button class="nav-btn" data-nav="products">
            <i class="fa-solid fa-box"></i> Produits
        </button>
        <button class="nav-btn" data-nav="reports">
            <i class="fa-solid fa-file-alt"></i> Rapports
        </button>
        <button class="nav-btn admin-only" data-nav="admin" style="display:none;">
            <i class="fa-solid fa-user-shield"></i> Admin
        </button>
    </div>

    <div id="modal-add-product" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">
                    <i class="fa-solid fa-plus"></i> Ajouter un produit
                </h3>
                <button class="close-modal" id="close-add-product-modal">
                    <i class="fa-solid fa-times"></i>
                </button>
            </div>
            
            <div class="form-group">
                <label class="form-label">Nom du produit</label>
                <input type="text" id="new-prod-name" class="form-input" placeholder="ex: Bock 66">
            </div>
            
            <div class="form-row">
                <div class="form-group">
                    <label class="form-label">Prix (FCFA)</label>
                    <input type="number" id="new-prod-price" class="form-input" placeholder="ex: 1000">
                </div>
                <div class="form-group">
                    <label class="form-label">Stock initial</label>
                    <input type="number" id="new-prod-stock" class="form-input" placeholder="ex: 24">
                </div>
            </div>
            
            <div class="form-group">
                <label class="form-label">Catégorie</label>
                <select id="new-prod-category" class="form-select">
                    <option value="beer">Bières</option>
                    <option value="soft">Boissons non alcoolisées</option>
                    <option value="food">Nourriture</option>
                    <option value="other">Autres</option>
                </select>
            </div>
            
            <div class="modal-footer">
                <button class="btn-cancel" id="cancel-add-product">Annuler</button>
                <button class="btn-submit" id="submit-add-product">Ajouter</button>
            </div>
        </div>
    </div>

    <div id="modal-quick-sale" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">
                    <i class="fa-solid fa-cash-register"></i> Vente manuelle
                </h3>
                <button class="close-modal" id="close-quick-sale-modal">
                    <i class="fa-solid fa-times"></i>
                </button>
            </div>
            
            <div class="form-group">
                <label class="form-label">Produit</label>
                <select id="sale-product-select" class="form-select">
                    </select>
            </div>
            
            <div class="form-row">
                <div class="form-group">
                    <label class="form-label">Quantité</label>
                    <input type="number" id="sale-quantity" class="form-input" value="1" min="1">
                </div>
                <div class="form-group">
                    <label class="form-label">Prix unitaire (FCFA)</label>
                    <input type="number" id="sale-price" class="form-input" readonly>
                </div>
            </div>
            
            <div class="form-group">
                <label class="form-label">Total (FCFA)</label>
                <input type="number" id="sale-total" class="form-input" readonly>
            </div>
            
            <div class="form-group">
                <label class="form-label">Notes (optionnel)</label>
                <input type="text" id="sale-notes" class="form-input" placeholder="Notes sur cette vente">
            </div>
            
            <div class="modal-footer">
                <button class="btn-cancel" id="cancel-quick-sale">Annuler</button>
                <button class="btn-submit" id="submit-quick-sale">Enregistrer la vente</button>
            </div>
        </div>
    </div>

    <div id="modal-add-expense" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">
                    <i class="fa-solid fa-money-bill-transfer"></i> Ajouter une dépense
                </h3>
                <button class="close-modal" id="close-expense-modal">
                    <i class="fa-solid fa-times"></i>
                </button>
            </div>
            
            <div class="form-group">
                <label class="form-label">Motif</label>
                <input type="text" id="exp-reason" class="form-input" placeholder="ex: Glace, Transport">
            </div>
            
            <div class="form-group">
                <label class="form-label">Montant (FCFA)</label>
                <input type="number" id="exp-amount" class="form-input" placeholder="ex: 5000">
            </div>
            
            <div class="form-group">
                <label class="form-label">Catégorie</label>
                <select id="exp-category" class="form-select">
                    <option value="transport">Transport</option>
                    <option value="food">Nourriture</option>
                    <option value="supplies">Fournitures</option>
                    <option value="maintenance">Entretien</option>
                    <option value="other">Autres</option>
                </select>
            </div>
            
            <div class="modal-footer">
                <button class="btn-cancel" id="cancel-expense">Annuler</button>
                <button class="btn-submit" id="submit-expense">Enregistrer</button>
            </div>
        </div>
    </div>

    <div id="modal-add-employee" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">
                    <i class="fa-solid fa-user-plus"></i> Nouvel Employé
                </h3>
                <button class="close-modal" id="close-employee-modal">
                    <i class="fa-solid fa-times"></i>
                </button>
            </div>
            
            <div class="form-group">
                <label class="form-label">Nom complet</label>
                <input type="text" id="emp-name" class="form-input" placeholder="ex: Kouassi Jean">
            </div>
            
            <div class="form-row">
                <div class="form-group">
                    <label class="form-label">Rôle</label>
                    <select id="emp-role" class="form-select">
                        <option value="Serveur">Serveur</option>
                        <option value="Caissier">Caissier</option>
                        <option value="Gérant">Gérant</option>
                        <option value="Sécurité">Sécurité</option>
                    </select>
                </div>
                <div class="form-group">
                    <label class="form-label">Téléphone</label>
                    <input type="tel" id="emp-phone" class="form-input" placeholder="07...">
                </div>
            </div>
            
            <div class="modal-footer">
                <button class="btn-cancel" id="cancel-employee">Annuler</button>
                <button class="btn-submit" id="submit-employee">Ajouter</button>
            </div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getAnalytics } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-analytics.js";
        import { getAuth, createUserWithEmailAndPassword, signInWithEmailAndPassword, onAuthStateChanged, signOut } 
        from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
        import { getFirestore, doc, setDoc, updateDoc, onSnapshot, arrayUnion, getDoc, collection, query, where, getDocs } 
        from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        // CONFIG FIREBASE
        const firebaseConfig = {
          apiKey: "AIzaSyCb22QgS99n6gzYmcCJoPzsVwd1uwg9g7k",
          authDomain: "maquismanager.firebaseapp.com",
          projectId: "maquismanager",
          storageBucket: "maquismanager.firebasestorage.app",
          messagingSenderId: "565292456302",
          appId: "1:565292456302:web:ef737768b5e0f06a05897f",
          measurementId: "G-MWWLQJK1SL"
        };

        const app = initializeApp(firebaseConfig);
        const analytics = getAnalytics(app);
        const auth = getAuth(app);
        const db = getFirestore(app);

        let currentUser = null;
        let currentData = null;
        let isAdmin = false;
        
        // Variables pour les graphiques
        let monthlyChartInstance = null;
        let productChartInstance = null;

        // DOM ELEMENTS
        const elements = {
            // Auth elements
            loginScreen: document.getElementById('login-screen'),
            appContainer: document.getElementById('app-container'),
            bottomNav: document.getElementById('bottom-nav'),
            emailInput: document.getElementById('email'),
            passwordInput: document.getElementById('password'),
            authMsg: document.getElementById('auth-msg'),
            loginBtn: document.getElementById('login-btn'),
            registerBtn: document.getElementById('register-btn'),
            logoutBtn: document.getElementById('logout-btn'),
            userRole: document.getElementById('user-role'),
            
            // Dashboard elements
            netDisplay: document.getElementById('net-display'),
            caDisplay: document.getElementById('ca-display'),
            expenseDisplay: document.getElementById('expense-display'),
            salesCount: document.getElementById('sales-count'),
            stockCount: document.getElementById('stock-count'),
            
            // Tab elements
            tabBtns: document.querySelectorAll('.tab-btn'),
            tabContents: document.querySelectorAll('.tab-content'),
            navBtns: document.querySelectorAll('.nav-btn'),
            adminOnlyElements: document.querySelectorAll('.admin-only'),
            
            // Product elements
            productsList: document.getElementById('products-list'),
            productsListAdmin: document.getElementById('products-list-admin'),
            productSearch: document.getElementById('product-search'),
            productSearchAdmin: document.getElementById('product-search-admin'),
            
            // Log elements
            logsList: document.getElementById('logs-list'),
            logFilterBtns: document.querySelectorAll('.log-filter-btn'),
            
            // UI elements
            loader: document.getElementById('loader'),
            toast: document.getElementById('toast'),
            
            // Admin elements
            employeeList: document.getElementById('employee-list'),
            lastBackup: document.getElementById('last-backup')
        };

        // EVENT LISTENERS
        elements.loginBtn.addEventListener('click', handleLogin);
        elements.registerBtn.addEventListener('click', handleRegister);
        elements.logoutBtn.addEventListener('click', handleLogout);
        
        // Tab navigation
        elements.tabBtns.forEach(btn => {
            btn.addEventListener('click', () => {
                const tabName = btn.getAttribute('data-tab');
                switchTab(tabName);
            });
        });
        
        // Bottom navigation
        elements.navBtns.forEach(btn => {
            btn.addEventListener('click', () => {
                const navName = btn.getAttribute('data-nav');
                switchTab(navName);
            });
        });
        
        // Product modals
        document.getElementById('add-product-btn').addEventListener('click', () => openModal('modal-add-product'));
        document.getElementById('close-add-product-modal').addEventListener('click', () => closeModal('modal-add-product'));
        document.getElementById('cancel-add-product').addEventListener('click', () => closeModal('modal-add-product'));
        document.getElementById('submit-add-product').addEventListener('click', handleAddProduct);
        
        // Quick sale modal
        document.getElementById('quick-sale-btn').addEventListener('click', () => openModal('modal-quick-sale'));
        document.getElementById('close-quick-sale-modal').addEventListener('click', () => closeModal('modal-quick-sale'));
        document.getElementById('cancel-quick-sale').addEventListener('click', () => closeModal('modal-quick-sale'));
        document.getElementById('submit-quick-sale').addEventListener('click', handleQuickSale);
        
        // Expense modal
        document.getElementById('close-expense-modal').addEventListener('click', () => closeModal('modal-add-expense'));
        document.getElementById('cancel-expense').addEventListener('click', () => closeModal('modal-add-expense'));
        document.getElementById('submit-expense').addEventListener('click', handleAddExpense);

        // Employee modal listeners
        document.getElementById('add-employee-btn').addEventListener('click', () => openModal('modal-add-employee'));
        document.getElementById('close-employee-modal').addEventListener('click', () => closeModal('modal-add-employee'));
        document.getElementById('cancel-employee').addEventListener('click', () => closeModal('modal-add-employee'));
        document.getElementById('submit-employee').addEventListener('click', handleAddEmployee);
        
        // Search functionality
        elements.productSearch.addEventListener('input', () => handleProductSearch('products-list'));
        elements.productSearchAdmin.addEventListener('input', () => handleProductSearch('products-list-admin'));
        
        // Log filter
        elements.logFilterBtns.forEach(btn => {
            btn.addEventListener('click', () => {
                const filter = btn.getAttribute('data-filter');
                filterLogs(filter);
                
                // Update active state
                elements.logFilterBtns.forEach(b => b.classList.remove('active'));
                btn.classList.add('active');
            });
        });
        
        // Report buttons
        document.getElementById('daily-report-btn').addEventListener('click', () => generateReport('daily'));
        document.getElementById('weekly-report-btn').addEventListener('click', () => generateReport('weekly'));
        document.getElementById('monthly-report-btn').addEventListener('click', () => generateReport('monthly'));
        document.getElementById('whatsapp-report-btn').addEventListener('click', sendWhatsAppReport);
        
        // Export buttons
        document.getElementById('export-sales-btn').addEventListener('click', () => exportData('sales'));
        document.getElementById('export-products-btn').addEventListener('click', () => exportData('products'));
        document.getElementById('export-logs-btn').addEventListener('click', () => exportData('logs'));
        document.getElementById('export-all-btn').addEventListener('click', () => exportData('all'));
        
        // Settings toggles
        document.getElementById('notification-toggle').addEventListener('click', function() {
            this.classList.toggle('active');
            updateSetting('notifications', this.classList.contains('active'));
        });
        
        document.getElementById('backup-toggle').addEventListener('click', function() {
            this.classList.toggle('active');
            updateSetting('autoBackup', this.classList.contains('active'));
        });
        
        document.getElementById('daily-report-toggle').addEventListener('click', function() {
            this.classList.toggle('active');
            updateSetting('dailyReport', this.classList.contains('active'));
        });
        
        // Backup button
        document.getElementById('backup-now-btn').addEventListener('click', performBackup);
        
        // Quick sale calculations
        document.getElementById('sale-product-select').addEventListener('change', updateQuickSalePrice);
        document.getElementById('sale-quantity').addEventListener('input', updateQuickSaleTotal);

        // AUTH FUNCTIONS
        async function handleLogin() {
            const email = elements.emailInput.value.trim();
            const password = elements.passwordInput.value;
            
            if (!email || !password) {
                showToast('Veuillez remplir tous les champs', 'error');
                return;
            }
            
            showLoader(true);
            elements.authMsg.textContent = '';
            
            try {
                const userCredential = await signInWithEmailAndPassword(auth, email, password);
                showToast('Connexion réussie!', 'success');
            } catch (error) {
                console.error("Erreur de connexion:", error);
                elements.authMsg.textContent = "Erreur: " + error.message;
                showLoader(false);
            }
        }

        async function handleRegister() {
            const email = elements.emailInput.value.trim();
            const password = elements.passwordInput.value;
            
            if (!email || !password) {
                showToast('Veuillez remplir tous les champs', 'error');
                return;
            }
            
            if (password.length < 6) {
                showToast('Le mot de passe doit contenir au moins 6 caractères', 'error');
                return;
            }
            
            showLoader(true);
            elements.authMsg.textContent = '';
            
            try {
                const cred = await createUserWithEmailAndPassword(auth, email, password);
                
                // Créer le document maquis pour cet utilisateur
                await setDoc(doc(db, "maquis", cred.user.uid), {
                    ca_day: 0,
                    expense_day: 0,
                    ca_month: {},
                    expense_month: {},
                    products: [
                        { id: 1, name: "Bock 66", price: 1000, stock: 24, category: "beer" },
                        { id: 2, name: "Ivoire", price: 1100, stock: 24, category: "beer" }
                    ],
                    employees: [],
                    logs: [],
                    salesHistory: [],
                    settings: {
                        notifications: true,
                        autoBackup: true,
                        dailyReport: false
                    },
                    lastBackup: new Date(),
                    role: "admin", 
                    createdAt: new Date()
                });
                
                showToast("Compte créé avec succès!", 'success');
            } catch (error) {
                console.error("Erreur d'inscription:", error);
                elements.authMsg.textContent = error.message;
                showLoader(false);
            }
        }

        function handleLogout() {
            signOut(auth);
        }

        onAuthStateChanged(auth, async (user) => {
            showLoader(false);
            if (user) {
                currentUser = user;
                
                try {
                    const userDoc = await getDoc(doc(db, "maquis", user.uid));
                    if (userDoc.exists()) {
                        const userData = userDoc.data();
                        currentData = userData;
                        isAdmin = userData.role === 'admin';
                        
                        elements.userRole.textContent = isAdmin ? 'Administrateur' : 'Employé';
                        
                        elements.adminOnlyElements.forEach(el => {
                            el.style.display = isAdmin ? 'flex' : 'none';
                        });
                        
                        elements.loginScreen.style.display = 'none';
                        elements.appContainer.style.display = 'block';
                        elements.bottomNav.style.display = 'flex';
                        
                        initRealTimeData();
                        renderUI(userData);
                    } else {
                        // Init new user data if missing
                        const initialData = {
                            ca_day: 0,
                            expense_day: 0,
                            ca_month: {},
                            expense_month: {},
                            products: [
                                { id: 1, name: "Bock 66", price: 1000, stock: 24, category: "beer" }
                            ],
                            employees: [],
                            logs: [],
                            salesHistory: [],
                            settings: { notifications: true, autoBackup: true },
                            role: "admin",
                            createdAt: new Date()
                        };
                        await setDoc(doc(db, "maquis", user.uid), initialData);
                        currentData = initialData;
                        isAdmin = true;
                        
                        elements.userRole.textContent = 'Administrateur';
                        elements.adminOnlyElements.forEach(el => el.style.display = 'flex');
                        elements.loginScreen.style.display = 'none';
                        elements.appContainer.style.display = 'block';
                        elements.bottomNav.style.display = 'flex';
                        initRealTimeData();
                        renderUI(initialData);
                    }
                } catch (error) {
                    console.error("Erreur load data:", error);
                    showToast("Erreur lors du chargement des données", 'error');
                }
            } else {
                currentUser = null;
                currentData = null;
                isAdmin = false;
                elements.loginScreen.style.display = 'flex';
                elements.appContainer.style.display = 'none';
                elements.bottomNav.style.display = 'none';
            }
        });

        // DATA SYNC
        function initRealTimeData() {
            if (!currentUser) return;
            
            onSnapshot(doc(db, "maquis", currentUser.uid), (docSnap) => {
                if(docSnap.exists()) {
                    currentData = docSnap.data();
                    renderUI(currentData);
                    updateProductSelect(currentData.products);
                }
            });
        }

        function renderUI(data) {
            const ca = data.ca_day || 0;
            const exp = data.expense_day || 0;
            const net = ca - exp;
            const salesCount = data.salesHistory ? data.salesHistory.length : 0;
            const stockCount = data.products ? data.products.reduce((sum, p) => sum + p.stock, 0) : 0;

            elements.netDisplay.innerText = net.toLocaleString() + " FCFA";
            elements.caDisplay.innerText = ca.toLocaleString() + " FCFA";
            elements.expenseDisplay.innerText = exp.toLocaleString() + " FCFA";
            elements.salesCount.innerText = salesCount;
            elements.stockCount.innerText = stockCount;

            // Products
            renderProducts(data.products, 'products-list');
            renderProducts(data.products, 'products-list-admin', true);
            
            // Employees
            renderEmployees(data.employees);

            // Logs
            renderLogs(data.logs);
            
            // Charts
            renderCharts(data);
            
            // Last backup
            if (data.lastBackup) {
                const lastBackupDate = data.lastBackup.toDate ? data.lastBackup.toDate() : new Date(data.lastBackup);
                const now = new Date();
                const diffMs = now - lastBackupDate;
                const diffMins = Math.floor(diffMs / 60000);
                let timeText;
                if (diffMins < 60) timeText = `Il y a ${diffMins} minute${diffMins > 1 ? 's' : ''}`;
                else if (diffMins < 1440) {
                    const diffHours = Math.floor(diffMins / 60);
                    timeText = `Il y a ${diffHours} heure${diffHours > 1 ? 's' : ''}`;
                } else {
                    const diffDays = Math.floor(diffMins / 1440);
                    timeText = `Il y a ${diffDays} jour${diffDays > 1 ? 's' : ''}`;
                }
                elements.lastBackup.textContent = timeText;
            }
        }

        function renderCharts(data) {
            // Graphique Mensuel
            const ctxMonthly = document.getElementById('monthly-chart').getContext('2d');
            const months = ['Jan', 'Fév', 'Mar', 'Avr', 'Mai', 'Juin', 'Juil', 'Août', 'Sep', 'Oct', 'Nov', 'Déc'];
            const salesData = Array(12).fill(0);
            const expenseData = Array(12).fill(0);
            
            if (data.ca_month) {
                Object.keys(data.ca_month).forEach(key => {
                    const idx = parseInt(key) - 1;
                    if (idx >= 0 && idx < 12) salesData[idx] = data.ca_month[key];
                });
            }

            if (monthlyChartInstance) monthlyChartInstance.destroy();

            monthlyChartInstance = new Chart(ctxMonthly, {
                type: 'bar',
                data: {
                    labels: months,
                    datasets: [
                        {
                            label: 'Recettes',
                            data: salesData,
                            backgroundColor: '#FFD700',
                            borderRadius: 5
                        },
                        {
                            label: 'Dépenses',
                            data: expenseData,
                            backgroundColor: '#FF4444',
                            borderRadius: 5
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: { legend: { labels: { color: '#fff' } } },
                    scales: {
                        y: { grid: { color: '#333' }, ticks: { color: '#aaa' } },
                        x: { grid: { display: false }, ticks: { color: '#aaa' } }
                    }
                }
            });

            // Graphique Produits
            const ctxProduct = document.getElementById('product-chart').getContext('2d');
            const productSales = {};
            if (data.salesHistory) {
                data.salesHistory.forEach(sale => {
                    productSales[sale.productName] = (productSales[sale.productName] || 0) + (sale.quantity || 1);
                });
            }

            const sortedProducts = Object.entries(productSales)
                .sort(([,a], [,b]) => b - a)
                .slice(0, 5);
            
            const prodLabels = sortedProducts.map(([name]) => name);
            const prodData = sortedProducts.map(([,qty]) => qty);

            if (productChartInstance) productChartInstance.destroy();

            productChartInstance = new Chart(ctxProduct, {
                type: 'doughnut',
                data: {
                    labels: prodLabels.length ? prodLabels : ['Aucune vente'],
                    datasets: [{
                        data: prodData.length ? prodData : [1],
                        backgroundColor: ['#FFD700', '#FFaa00', '#FF4444', '#33b5e5', '#00C851'],
                        borderWidth: 0
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: { legend: { position: 'right', labels: { color: '#fff' } } }
                }
            });
        }

        function renderProducts(products, containerId, includeActions = false) {
            const container = document.getElementById(containerId);
            container.innerHTML = '';
            
            if(products && products.length > 0) {
                products.forEach((p, index) => {
                    const productItem = document.createElement('div');
                    productItem.className = 'product-item';
                    productItem.innerHTML = `
                        <div class="product-info">
                            <div class="product-icon">
                                ${getProductIcon(p.category)}
                            </div>
                            <div class="product-details">
                                <div class="product-name">${p.name}</div>
                                <div class="product-price">${p.price} FCFA</div>
                            </div>
                        </div>
                        <div class="product-actions">
                            <span class="stock-badge ${p.stock < 5 ? 'low' : ''}">
                                <i class="fa-solid fa-box"></i> Stock: ${p.stock}
                            </span>
                            ${includeActions ? `
                                <div class="product-buttons">
                                    <button class="btn-sell" data-index="${index}"><i class="fa-solid fa-shopping-cart"></i> Vendre</button>
                                    <button class="btn-edit" data-index="${index}"><i class="fa-solid fa-edit"></i></button>
                                    <button class="btn-delete" data-index="${index}"><i class="fa-solid fa-trash"></i></button>
                                </div>
                            ` : `
                                <button class="btn-sell" data-index="${index}"><i class="fa-solid fa-shopping-cart"></i> Vendre</button>
                            `}
                        </div>
                    `;
                    container.appendChild(productItem);
                });
                
                if (includeActions) {
                    document.querySelectorAll('.btn-edit').forEach(btn => {
                        btn.addEventListener('click', (e) => {
                            const index = parseInt(e.currentTarget.getAttribute('data-index'));
                            editProduct(index);
                        });
                    });
                    document.querySelectorAll('.btn-delete').forEach(btn => {
                        btn.addEventListener('click', (e) => {
                            const index = parseInt(e.currentTarget.getAttribute('data-index'));
                            deleteProduct(index);
                        });
                    });
                }
                
                document.querySelectorAll('.btn-sell').forEach(btn => {
                    btn.addEventListener('click', (e) => {
                        const index = parseInt(e.currentTarget.getAttribute('data-index'));
                        sellProduct(index);
                    });
                });
            } else {
                container.innerHTML = '<p style="text-align:center; color:#666; padding:20px;">Aucun produit.</p>';
            }
        }

        function renderEmployees(employees) {
            const container = document.getElementById('employee-list');
            container.innerHTML = '';

            if (employees && employees.length > 0) {
                employees.forEach((emp, index) => {
                    const item = document.createElement('div');
                    item.className = 'employee-item';
                    const initial = emp.name ? emp.name.charAt(0).toUpperCase() : '?';

                    item.innerHTML = `
                        <div class="employee-avatar">${initial}</div>
                        <div class="employee-info">
                            <div class="employee-name">${emp.name}</div>
                            <div class="employee-role">
                                <i class="fa-solid fa-briefcase" style="font-size:12px"></i> ${emp.role} 
                                ${emp.phone ? ` • <i class="fa-solid fa-phone" style="font-size:12px"></i> ${emp.phone}` : ''}
                            </div>
                        </div>
                        <div class="employee-actions">
                            <button class="btn-employee delete-emp-btn" data-index="${index}" title="Supprimer">
                                <i class="fa-solid fa-trash" style="color:var(--danger)"></i>
                            </button>
                        </div>
                    `;
                    container.appendChild(item);
                });

                document.querySelectorAll('.delete-emp-btn').forEach(btn => {
                    btn.addEventListener('click', (e) => {
                        const index = e.currentTarget.getAttribute('data-index');
                        deleteEmployee(parseInt(index));
                    });
                });
            } else {
                container.innerHTML = '<p style="text-align:center; color:#666; padding:15px; font-size:14px;">Aucun employé enregistré.</p>';
            }
        }

        function renderLogs(logs) {
            elements.logsList.innerHTML = '';
            if(logs && logs.length > 0) {
                const recentLogs = logs.slice(-20).reverse();
                recentLogs.forEach(log => {
                    const logItem = document.createElement('div');
                    logItem.className = 'log-item';
                    logItem.setAttribute('data-type', log.type);
                    
                    let iconClass;
                    if (log.type === 'sale') iconClass = 'fa-shopping-cart';
                    else if (log.type === 'expense') iconClass = 'fa-money-bill-transfer';
                    else if (log.type === 'restock') iconClass = 'fa-box';
                    else iconClass = 'fa-info-circle';
                    
                    logItem.innerHTML = `
                        <div class="log-content">
                            <div class="log-icon ${log.type}">
                                <i class="fa-solid ${iconClass}"></i>
                            </div>
                            <div class="log-details">
                                <div class="log-desc">${log.desc}</div>
                                <div class="log-time">${log.time}</div>
                            </div>
                        </div>
                        ${log.amount ? `<div class="log-amount">${log.amount} FCFA</div>` : ''}
                    `;
                    elements.logsList.appendChild(logItem);
                });
            } else {
                elements.logsList.innerHTML = '<div style="text-align:center; padding:20px; color:#444;">Aucune activité récente</div>';
            }
        }

        // ACTIONS
        async function sellProduct(index) {
            if(!currentData) return;
            const p = currentData.products[index];
            if(p.stock > 0) {
                const newProducts = [...currentData.products];
                newProducts[index].stock--;
                
                const log = { type: 'sale', desc: `Vente: ${p.name}`, time: new Date().toLocaleTimeString(), amount: p.price };
                const saleRecord = { productName: p.name, price: p.price, time: new Date().toLocaleString() };
                
                try {
                    await updateDoc(doc(db, "maquis", currentUser.uid), {
                        products: newProducts,
                        ca_day: (currentData.ca_day || 0) + parseInt(p.price),
                        logs: arrayUnion(log),
                        salesHistory: arrayUnion(saleRecord)
                    });
                    
                    // Monthly data
                    const currentMonth = new Date().getMonth() + 1;
                    const monthKey = currentMonth.toString();
                    const monthData = currentData.ca_month || {};
                    monthData[monthKey] = (monthData[monthKey] || 0) + parseInt(p.price);
                    
                    await updateDoc(doc(db, "maquis", currentUser.uid), { ca_month: monthData });
                    
                    if(navigator.vibrate) navigator.vibrate(50);
                    showToast(`${p.name} vendu avec succès!`, 'success');
                } catch (error) {
                    showToast("Erreur lors de la vente: " + error.message, 'error');
                }
            } else {
                showToast("Stock Épuisé !", 'error');
            }
        }

        async function handleAddProduct() {
            const name = document.getElementById('new-prod-name').value.trim();
            const price = parseInt(document.getElementById('new-prod-price').value);
            const stock = parseInt(document.getElementById('new-prod-stock').value);
            const category = document.getElementById('new-prod-category').value;

            if(!name || !price || !stock) {
                showToast('Veuillez remplir tous les champs', 'error');
                return;
            }

            const newProd = { id: Date.now(), name, price, stock, category };
            const newList = currentData.products ? [...currentData.products, newProd] : [newProd];
            
            try {
                await updateDoc(doc(db, "maquis", currentUser.uid), { products: newList });
                showToast("Produit ajouté avec succès!", 'success');
                closeModal('modal-add-product');
                document.getElementById('new-prod-name').value = "";
                document.getElementById('new-prod-price').value = "";
                document.getElementById('new-prod-stock').value = "";
            } catch (error) {
                showToast("Erreur: " + error.message, 'error');
            }
        }

        async function editProduct(index) {
            const product = currentData.products[index];
            const newName = prompt("Nouveau nom du produit:", product.name);
            if (newName && newName.trim()) {
                const newPrice = prompt("Nouveau prix:", product.price);
                if (newPrice && !isNaN(newPrice) && newPrice > 0) {
                    const newStock = prompt("Nouveau stock:", product.stock);
                    if (newStock && !isNaN(newStock) && newStock >= 0) {
                        try {
                            const newProducts = [...currentData.products];
                            newProducts[index] = { ...newProducts[index], name: newName.trim(), price: parseInt(newPrice), stock: parseInt(newStock) };
                            await updateDoc(doc(db, "maquis", currentUser.uid), { products: newProducts });
                            showToast("Produit modifié!", 'success');
                        } catch (error) {
                            showToast("Erreur: " + error.message, 'error');
                        }
                    }
                }
            }
        }

        async function deleteProduct(index) {
            if (!confirm("Êtes-vous sûr de vouloir supprimer ce produit?")) return;
            const newProducts = [...currentData.products];
            newProducts.splice(index, 1);
            try {
                await updateDoc(doc(db, "maquis", currentUser.uid), { products: newProducts });
                showToast("Produit supprimé!", 'success');
            } catch (error) {
                showToast("Erreur: " + error.message, 'error');
            }
        }

        function updateProductSelect(products) {
            const select = document.getElementById('sale-product-select');
            select.innerHTML = '';
            if(products) {
                products.forEach((p, index) => {
                    const option = document.createElement('option');
                    option.value = index;
                    option.innerHTML = `${p.name} - ${p.price} FCFA`;
                    select.appendChild(option);
                });
                updateQuickSalePrice();
            }
        }

        function updateQuickSalePrice() {
            const index = document.getElementById('sale-product-select').value;
            if (index !== '' && currentData && currentData.products) {
                const product = currentData.products[index];
                document.getElementById('sale-price').value = product.price;
                updateQuickSaleTotal();
            }
        }

        function updateQuickSaleTotal() {
            const price = parseInt(document.getElementById('sale-price').value) || 0;
            const quantity = parseInt(document.getElementById('sale-quantity').value) || 1;
            document.getElementById('sale-total').value = price * quantity;
        }

        async function handleQuickSale() {
            const index = document.getElementById('sale-product-select').value;
            const quantity = parseInt(document.getElementById('sale-quantity').value) || 1;
            const notes = document.getElementById('sale-notes').value.trim();
            
            if(index === '' || quantity <= 0) return;
            
            const product = currentData.products[index];
            if(product.stock < quantity) {
                showToast(`Stock insuffisant! (${product.stock} dispo)`, 'error');
                return;
            }
            
            try {
                const newProducts = [...currentData.products];
                newProducts[index].stock -= quantity;
                const log = { type: 'sale', desc: `Vente: ${quantity}x ${product.name}`, time: new Date().toLocaleTimeString(), amount: product.price * quantity };
                const saleRecord = { productName: product.name, price: product.price, quantity: quantity, total: product.price * quantity, time: new Date().toLocaleString(), notes: notes };
                
                await updateDoc(doc(db, "maquis", currentUser.uid), {
                    products: newProducts,
                    ca_day: (currentData.ca_day || 0) + (product.price * quantity),
                    logs: arrayUnion(log),
                    salesHistory: arrayUnion(saleRecord)
                });
                
                const currentMonth = new Date().getMonth() + 1;
                const monthKey = currentMonth.toString();
                const monthData = currentData.ca_month || {};
                monthData[monthKey] = (monthData[monthKey] || 0) + (product.price * quantity);
                await updateDoc(doc(db, "maquis", currentUser.uid), { ca_month: monthData });
                
                closeModal('modal-quick-sale');
                showToast("Vente enregistrée!", 'success');
                document.getElementById('sale-quantity').value = 1;
                document.getElementById('sale-notes').value = "";
            } catch (error) {
                showToast("Erreur: " + error.message, 'error');
            }
        }

        async function handleAddExpense() {
            const reason = document.getElementById('exp-reason').value.trim();
            const amount = parseInt(document.getElementById('exp-amount').value);
            const category = document.getElementById('exp-category').value;
            
            if(!reason || !amount) {
                showToast('Champs manquants', 'error');
                return;
            }
            
            const log = { type: 'expense', desc: `Sortie: ${amount}F (${reason})`, time: new Date().toLocaleTimeString(), amount: amount, category: category };
            
            try {
                await updateDoc(doc(db, "maquis", currentUser.uid), {
                    expense_day: (currentData.expense_day || 0) + amount,
                    logs: arrayUnion(log)
                });
                
                const currentMonth = new Date().getMonth() + 1;
                const monthKey = currentMonth.toString();
                const monthData = currentData.expense_month || {};
                monthData[monthKey] = (monthData[monthKey] || 0) + amount;
                await updateDoc(doc(db, "maquis", currentUser.uid), { expense_month: monthData });
                
                closeModal('modal-add-expense');
                document.getElementById('exp-reason').value = "";
                document.getElementById('exp-amount').value = "";
                showToast("Dépense enregistrée!", 'success');
            } catch (error) {
                showToast("Erreur: " + error.message, 'error');
            }
        }

        async function handleAddEmployee() {
            const name = document.getElementById('emp-name').value.trim();
            const role = document.getElementById('emp-role').value;
            const phone = document.getElementById('emp-phone').value.trim();

            if (!name) {
                showToast('Veuillez entrer le nom de l\'employé', 'error');
                return;
            }

            const newEmployee = { id: Date.now(), name, role, phone, addedAt: new Date().toISOString() };
            const currentEmployees = currentData.employees || [];
            const newEmployeeList = [...currentEmployees, newEmployee];

            try {
                await updateDoc(doc(db, "maquis", currentUser.uid), { employees: newEmployeeList });
                showToast("Employé ajouté!", 'success');
                closeModal('modal-add-employee');
                document.getElementById('emp-name').value = '';
                document.getElementById('emp-phone').value = '';
            } catch (error) {
                showToast("Erreur: " + error.message, 'error');
            }
        }

        async function deleteEmployee(index) {
            if (!confirm("Supprimer cet employé ?")) return;
            const currentEmployees = currentData.employees || [];
            const newEmployeeList = currentEmployees.filter((_, i) => i !== index);
            try {
                await updateDoc(doc(db, "maquis", currentUser.uid), { employees: newEmployeeList });
                showToast("Employé supprimé.", 'success');
            } catch (error) {
                showToast("Erreur: " + error.message, 'error');
            }
        }

        // UI HELPERS
        function switchTab(tabName) {
            elements.tabContents.forEach(tab => tab.classList.remove('active'));
            document.getElementById(`tab-${tabName}`).classList.add('active');
            elements.tabBtns.forEach(btn => {
                btn.classList.remove('active');
                if (btn.getAttribute('data-tab') === tabName) btn.classList.add('active');
            });
            elements.navBtns.forEach(btn => {
                btn.classList.remove('active');
                if (btn.getAttribute('data-nav') === tabName) btn.classList.add('active');
            });
        }

        function openModal(modalId) { document.getElementById(modalId).style.display = 'flex'; }
        function closeModal(modalId) { document.getElementById(modalId).style.display = 'none'; }

        function handleProductSearch(containerId) {
            const searchTerm = document.getElementById(containerId === 'products-list' ? 'product-search' : 'product-search-admin').value.toLowerCase();
            const productItems = document.querySelectorAll(`#${containerId} .product-item`);
            productItems.forEach(item => {
                const productName = item.querySelector('.product-name').textContent.toLowerCase();
                item.style.display = productName.includes(searchTerm) ? 'flex' : 'none';
            });
        }

        function filterLogs(filterType) {
            const logItems = document.querySelectorAll('.log-item');
            logItems.forEach(item => {
                const itemType = item.getAttribute('data-type');
                item.style.display = (filterType === 'all' || itemType === filterType) ? 'flex' : 'none';
            });
        }

        function generateReport(period) {
            showToast(`Génération du rapport ${period} en cours...`, 'info');
            setTimeout(() => showToast(`Rapport ${period} prêt!`, 'success'), 2000);
        }

        function sendWhatsAppReport() {
            if(!currentData) return;
            const d = new Date();
            let msg = `*📊 RAPPORT - ${d.toLocaleDateString()}* %0a------------------%0a`;
            msg += `✅ Ventes: ${currentData.ca_day} F %0a`;
            msg += `🔻 Dépenses: -${currentData.expense_day || 0} F %0a`;
            msg += `💰 *NET CAISSE : ${(currentData.ca_day - (currentData.expense_day || 0))} F* %0a`;
            msg += `------------------%0a📦 STOCK : %0a`;
            currentData.products.forEach(p => msg += `- ${p.name} : ${p.stock} %0a`);
            window.open(`https://wa.me/?text=${msg}`, '_blank');
        }

        function exportData(dataType) {
            showToast(`Export ${dataType}...`, 'info');
            setTimeout(() => showToast(`Export réussi!`, 'success'), 2000);
        }

        async function updateSetting(setting, value) {
            try {
                const settings = currentData.settings || {};
                settings[setting] = value;
                await updateDoc(doc(db, "maquis", currentUser.uid), { settings: settings });
                showToast(`Paramètre mis à jour!`, 'success');
            } catch (error) {
                showToast("Erreur: " + error.message, 'error');
            }
        }

        async function performBackup() {
            try {
                await updateDoc(doc(db, "maquis", currentUser.uid), { lastBackup: new Date() });
                showToast("Sauvegarde réussie!", 'success');
                renderUI(currentData);
            } catch (error) {
                showToast("Erreur: " + error.message, 'error');
            }
        }

        function showLoader(show) {
            elements.loader.style.opacity = show ? '1' : '0';
            setTimeout(() => elements.loader.style.display = show ? 'flex' : 'none', 500);
        }

        function showToast(message, type = 'success') {
            elements.toast.textContent = message;
            elements.toast.className = 'toast show ' + (type === 'error' ? 'error' : (type === 'info' ? 'info' : ''));
            setTimeout(() => elements.toast.classList.remove('show'), 3000);
        }

        function getProductIcon(category) {
            if (category === 'beer') return '<i class="fa-solid fa-beer"></i>';
            if (category === 'soft') return '<i class="fa-solid fa-glass-water"></i>';
            if (category === 'food') return '<i class="fa-solid fa-utensils"></i>';
            return '<i class="fa-solid fa-box"></i>';
        }

        // Initialize app
        showLoader(true);
    </script>
</body>
</html>

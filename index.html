<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Maquis Manager V4</title>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <style>
        :root {
            --bg: #121212; --card: #1e1e1e; --primary: #FFD700; --danger: #FF4444; --success: #00C851; --info: #33b5e5; --text: #fff;
        }
        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; outline: none; }
        body { background: var(--bg); color: var(--text); font-family: 'Poppins', sans-serif; margin: 0; padding: 20px; padding-bottom: 120px; }

        /* Header */
        header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; }
        .brand { font-size: 20px; font-weight: 700; color: var(--primary); letter-spacing: 1px; }
        .admin-btn { background: #333; color: white; border: 1px solid #555; padding: 10px 15px; border-radius: 12px; cursor: pointer; }

        /* Dashboard Principal (Journ√©e en cours) */
        .dashboard { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 20px; }
        .stat-card { background: var(--card); padding: 15px; border-radius: 15px; text-align: center; border: 1px solid #333; }
        .stat-card h3 { margin: 0; font-size: 11px; color: #aaa; text-transform: uppercase; }
        .stat-card .val { font-size: 20px; font-weight: 700; margin-top: 5px; }
        .big-card { grid-column: span 2; background: linear-gradient(135deg, #2c3e50, #000000); border: 1px solid var(--primary); }
        .big-card .val { font-size: 32px; color: var(--primary); }

        /* Grille Produits */
        .grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(150px, 1fr)); gap: 15px; }
        .product-card { background: var(--card); border-radius: 18px; padding: 15px; position: relative; border: 1px solid #333; transition: transform 0.1s; }
        .product-card:active { transform: scale(0.96); background: #252525; }
        .p-name { font-weight: 600; font-size: 16px; margin-bottom: 5px; }
        .p-price { color: var(--success); font-weight: 700; font-size: 14px; }
        .p-stock { font-size: 11px; color: #888; margin-top: 8px; display: flex; justify-content: space-between; }
        .bar-bg { background: #333; height: 4px; border-radius: 2px; margin-top: 5px; width: 100%; overflow: hidden; }
        .bar-fill { height: 100%; background: var(--success); width: 100%; transition: width 0.3s; }

        /* Actions Flottantes */
        .fab-container { position: fixed; bottom: 20px; left: 50%; transform: translateX(-50%); display: flex; gap: 10px; width: 90%; z-index: 99; }
        .btn-main { flex: 2; background: #25D366; color: white; padding: 16px; border: none; border-radius: 50px; font-weight: 700; font-size: 16px; box-shadow: 0 5px 15px rgba(37,211,102,0.3); }
        .btn-expense { flex: 1; background: var(--danger); color: white; padding: 16px; border: none; border-radius: 50px; font-weight: 700; display: flex; align-items: center; justify-content: center; box-shadow: 0 5px 15px rgba(255,68,68,0.3); }

        /* Modals */
        .modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.9); z-index: 1000; align-items: center; justify-content: center; backdrop-filter: blur(5px); }
        .modal-content { background: #1a1a1a; padding: 25px; border-radius: 20px; width: 90%; max-height: 85vh; overflow-y: auto; border: 1px solid #444; }
        .modal-title { margin-top: 0; color: var(--primary); }
        
        input { width: 100%; padding: 12px; margin: 8px 0; background: #333; border: 1px solid #555; color: white; border-radius: 8px; font-size: 16px; }
        .btn-save { background: var(--primary); color: black; width: 100%; padding: 12px; border: none; border-radius: 8px; font-weight: bold; font-size: 16px; margin-top: 15px; }
        .close-modal { position: absolute; top: 15px; right: 15px; color: #888; font-size: 24px; cursor: pointer; }

        /* ADMIN SPECIFIC */
        .admin-item { display: flex; gap: 5px; margin-bottom: 10px; align-items: center; background: #2a2a2a; padding: 10px; border-radius: 8px; }
        .admin-item input { margin: 0; font-size: 14px; padding: 8px; }
        .btn-del { background: var(--danger); color: white; border: none; padding: 8px; border-radius: 5px; }

        /* ADMIN STATS DASHBOARD */
        .monthly-stats {
            background: #252525; border-radius: 12px; padding: 15px; margin-bottom: 20px; border: 1px solid #444;
        }
        .stats-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-top: 10px; }
        .mini-stat { background: #1a1a1a; padding: 10px; border-radius: 8px; text-align: center; }
        .mini-stat span { font-size: 10px; color: #aaa; }
        .mini-stat div { font-size: 16px; font-weight: bold; }
        
        .btn-archive { background: linear-gradient(45deg, #1e3c72, #2a5298); color: white; width: 100%; padding: 15px; border: none; border-radius: 10px; margin-bottom: 20px; font-weight: bold; border: 1px solid #4a90e2; }

    </style>
</head>
<body>

    <div class="modal" id="modal-login">
        <div class="modal-content" style="text-align: center;">
            <i class="close-modal fa-solid fa-xmark" onclick="closeModal('modal-login')"></i>
            <h2 class="modal-title">üîê Acc√®s Patron</h2>
            <p style="color:#aaa; font-size:13px;">Entrez le code PIN (D√©faut: 0000)</p>
            <input type="password" id="pin-input" placeholder="Code PIN" style="text-align:center; font-size: 24px; letter-spacing: 5px;">
            <button class="btn-save" onclick="checkPin()">D√âVERROUILLER</button>
        </div>
    </div>

    <div class="modal" id="modal-admin">
        <div class="modal-content">
            <i class="close-modal fa-solid fa-xmark" onclick="closeModal('modal-admin')"></i>
            
            <h2 class="modal-title">üìä Stats du Mois</h2>
            <div class="monthly-stats">
                <div style="text-align:center; font-size:12px; color:#aaa; margin-bottom:5px;">CUMUL DU MOIS EN COURS</div>
                <div class="stats-grid">
                    <div class="mini-stat" style="border-bottom: 2px solid var(--success)">
                        <span>Recettes</span>
                        <div id="stat-m-sales" style="color:var(--success)">0 F</div>
                    </div>
                    <div class="mini-stat" style="border-bottom: 2px solid var(--danger)">
                        <span>D√©penses</span>
                        <div id="stat-m-expenses" style="color:var(--danger)">0 F</div>
                    </div>
                </div>
                <div class="mini-stat" style="margin-top:10px; background: #332b00; border: 1px solid var(--primary);">
                    <span style="color:var(--primary)">B√âN√âFICE NET (Cash)</span>
                    <div id="stat-m-profit" style="color:var(--primary); font-size: 20px;">0 F</div>
                </div>
            </div>

            <button class="btn-archive" onclick="archiveDay()"><i class="fa-solid fa-box-archive"></i> CL√îTURER LA JOURN√âE<br><span style="font-size:10px; font-weight:normal;">Remet les compteurs √† z√©ro et sauvegarde</span></button>

            <h2 class="modal-title">‚öôÔ∏è Stock & Produits</h2>
            <div id="admin-list"></div>

            <button class="btn-save" style="background:#333; color:white; border:1px dashed #777;" onclick="addNewProductItem()">+ Ajouter produit</button>
            
            <hr style="border-color:#333; margin:20px 0;">
            <input type="number" id="new-pin" placeholder="Changer le PIN">
            <button class="btn-save" onclick="saveAdminData()">üíæ SAUVEGARDER & QUITTER</button>
        </div>
    </div>

    <div class="modal" id="modal-expense">
        <div class="modal-content">
            <i class="close-modal fa-solid fa-xmark" onclick="closeModal('modal-expense')"></i>
            <h2 class="modal-title" style="color:var(--danger)">üí∏ Sortie de Caisse</h2>
            <label>Motif (ex: Glace, Transport)</label>
            <input type="text" id="expense-reason">
            <label>Montant (FCFA)</label>
            <input type="number" id="expense-amount">
            <button class="btn-save" style="background:var(--danger); color:white" onclick="addExpense()">VALIDER LA SORTIE</button>
        </div>
    </div>

    <header>
        <div class="brand"><i class="fa-solid fa-champagne-glasses"></i> MAQUIS<span style="color:white">MANAGER</span></div>
        <button class="admin-btn" onclick="openLogin()"><i class="fa-solid fa-lock"></i> Admin</button>
    </header>

    <div class="dashboard">
        <div class="stat-card big-card">
            <h3>Solde Caisse (Aujourd'hui)</h3>
            <div class="val" id="net-total">0 F</div>
        </div>
        <div class="stat-card">
            <h3>Ventes</h3>
            <div class="val" id="sales-total" style="color:var(--success)">0 F</div>
        </div>
        <div class="stat-card">
            <h3>Sorties</h3>
            <div class="val" id="expenses-total" style="color:var(--danger)">0 F</div>
        </div>
    </div>

    <div class="grid" id="product-grid"></div>

    <div class="fab-container">
        <button class="btn-expense" onclick="openModal('modal-expense')"><i class="fa-solid fa-money-bill-transfer"></i></button>
        <button class="btn-main" onclick="sendReport()"><i class="fa-brands fa-whatsapp"></i> POINT WHATSAPP</button>
    </div>

    <script>
        // --- DATA CONFIGURATION ---
        let defaultData = {
            pin: "0000",
            products: [
                { id: 1, name: "Bock 66", price: 1000, stock: 24, maxStock: 24, sold: 0 },
                { id: 2, name: "Ivoire", price: 1100, stock: 24, maxStock: 24, sold: 0 },
                { id: 3, name: "Chill", price: 1200, stock: 24, maxStock: 24, sold: 0 },
                { id: 4, name: "Eau", price: 500, stock: 24, maxStock: 24, sold: 0 }
            ],
            expenses: [], // D√©penses du jour
            history: []   // Historique des jours pr√©c√©dents { date, sales, expenses, profit }
        };

        let appData = JSON.parse(localStorage.getItem('maquisDataV4')) || defaultData;

        // --- CORE FUNCTIONS ---
        function saveData() {
            localStorage.setItem('maquisDataV4', JSON.stringify(appData));
            renderUI();
        }

        function renderUI() {
            // Calculs du jour
            let daySales = appData.products.reduce((acc, p) => acc + (p.sold * p.price), 0);
            let dayExpenses = appData.expenses.reduce((acc, e) => acc + e.amount, 0);
            let dayNet = daySales - dayExpenses;

            document.getElementById('sales-total').innerText = daySales.toLocaleString() + ' F';
            document.getElementById('expenses-total').innerText = dayExpenses.toLocaleString() + ' F';
            document.getElementById('net-total').innerText = dayNet.toLocaleString() + ' F';

            // Grille
            const grid = document.getElementById('product-grid');
            grid.innerHTML = '';
            appData.products.forEach(p => {
                let percent = p.maxStock > 0 ? (p.stock / p.maxStock) * 100 : 0;
                let barColor = percent < 20 ? 'var(--danger)' : (percent < 50 ? '#ffbb33' : 'var(--success)');

                grid.innerHTML += `
                <div class="product-card" onclick="sell(${p.id})">
                    <div class="p-name">${p.name}</div>
                    <div class="p-price">${p.price} F</div>
                    <div class="bar-bg"><div class="bar-fill" style="width:${percent}%; background:${barColor}"></div></div>
                    <div class="p-stock">
                        <span>Stock: <b>${p.stock}</b></span>
                        <span style="color:#aaa">Vendu: ${p.sold}</span>
                    </div>
                </div>`;
            });
        }

        function sell(id) {
            let p = appData.products.find(x => x.id === id);
            if (p && p.stock > 0) {
                p.stock--;
                p.sold++;
                if(navigator.vibrate) navigator.vibrate(50);
                saveData();
            } else {
                if(navigator.vibrate) navigator.vibrate([50,50,50]);
                alert("STOCK √âPUIS√â !");
            }
        }

        // --- EXPENSES ---
        function addExpense() {
            let reason = document.getElementById('expense-reason').value;
            let amount = parseInt(document.getElementById('expense-amount').value);
            if (reason && amount) {
                appData.expenses.push({ reason, amount, time: new Date().toLocaleTimeString() });
                closeModal('modal-expense');
                document.getElementById('expense-reason').value = '';
                document.getElementById('expense-amount').value = '';
                saveData();
            }
        }

        // --- ADMIN & STATS MENSUELLES ---
        function openModal(id) { document.getElementById(id).style.display = 'flex'; }
        function closeModal(id) { document.getElementById(id).style.display = 'none'; }

        function openLogin() {
            document.getElementById('pin-input').value = '';
            openModal('modal-login');
        }

        function checkPin() {
            let input = document.getElementById('pin-input').value;
            if (input === appData.pin) {
                closeModal('modal-login');
                openAdminPanel();
            } else { alert("Code PIN Incorrect !"); }
        }

        function openAdminPanel() {
            openModal('modal-admin');
            renderAdminProducts();
            calculateMonthlyStats();
        }

        function calculateMonthlyStats() {
            let currentMonth = new Date().getMonth(); // 0-11
            let currentYear = new Date().getFullYear();

            // 1. On prend l'historique
            let mSales = 0;
            let mExpenses = 0;

            if(appData.history) {
                appData.history.forEach(day => {
                    let d = new Date(day.dateIso); // Format ISO stock√©
                    if(d.getMonth() === currentMonth && d.getFullYear() === currentYear) {
                        mSales += day.sales;
                        mExpenses += day.expenses;
                    }
                });
            }

            // 2. On ajoute la journ√©e EN COURS (Live)
            let todaySales = appData.products.reduce((acc, p) => acc + (p.sold * p.price), 0);
            let todayExpenses = appData.expenses.reduce((acc, e) => acc + e.amount, 0);

            mSales += todaySales;
            mExpenses += todayExpenses;
            let mProfit = mSales - mExpenses;

            // 3. Affichage
            document.getElementById('stat-m-sales').innerText = mSales.toLocaleString() + " F";
            document.getElementById('stat-m-expenses').innerText = mExpenses.toLocaleString() + " F";
            document.getElementById('stat-m-profit').innerText = mProfit.toLocaleString() + " F";
        }

        // --- FONCTION CL√â : CL√îTURER JOURN√âE ---
        function archiveDay() {
            if(!confirm("‚ö†Ô∏è ATTENTION : Voulez-vous cl√¥turer la caisse du jour ?\nCela va remettre les ventes √† z√©ro et sauvegarder les chiffres.")) return;

            let todaySales = appData.products.reduce((acc, p) => acc + (p.sold * p.price), 0);
            let todayExpenses = appData.expenses.reduce((acc, e) => acc + e.amount, 0);
            let todayProfit = todaySales - todayExpenses;
            
            // Cr√©ation de l'archive
            let archive = {
                dateIso: new Date().toISOString(), // Pour le tri
                dateStr: new Date().toLocaleDateString(), // Pour l'affichage
                sales: todaySales,
                expenses: todayExpenses,
                profit: todayProfit
            };

            // Init history si n'existe pas
            if(!appData.history) appData.history = [];
            appData.history.push(archive);

            // RESET des compteurs journaliers
            appData.expenses = [];
            appData.products.forEach(p => {
                p.sold = 0; // On garde le stock, on reset juste les ventes
                // Optionnel: reset maxStock pour le lendemain ? Non, on garde.
            });

            saveData();
            alert("‚úÖ Journ√©e cl√¥tur√©e et sauvegard√©e !");
            openAdminPanel(); // Rafraichir les stats
        }

        // --- ADMIN GESTION PRODUITS ---
        function renderAdminProducts() {
            const list = document.getElementById('admin-list');
            list.innerHTML = '';
            appData.products.forEach((p, index) => {
                list.innerHTML += `
                <div class="admin-item">
                    <input type="text" value="${p.name}" onchange="updateProd(${index}, 'name', this.value)" style="width:40%">
                    <input type="number" value="${p.price}" onchange="updateProd(${index}, 'price', this.value)" style="width:25%">
                    <input type="number" value="${p.stock}" onchange="updateProd(${index}, 'stock', this.value)" style="width:20%; color:var(--primary)">
                    <button class="btn-del" onclick="deleteProd(${index})"><i class="fa-solid fa-trash"></i></button>
                </div>`;
            });
        }

        function updateProd(index, field, value) {
            if(field === 'stock') {
                appData.products[index].maxStock = parseInt(value);
                appData.products[index].stock = parseInt(value);
                appData.products[index].sold = 0; 
            } else if (field === 'price') {
                appData.products[index].price = parseInt(value);
            } else {
                appData.products[index][field] = value;
            }
        }
        
        function addNewProductItem() {
            appData.products.push({ id: Date.now(), name: 'Nouveau', price: 0, stock: 0, maxStock: 0, sold: 0 });
            renderAdminProducts();
        }

        function deleteProd(index) {
            if(confirm('Supprimer ?')) {
                appData.products.splice(index, 1);
                renderAdminProducts();
            }
        }

        function saveAdminData() {
            let newPin = document.getElementById('new-pin').value;
            if(newPin) appData.pin = newPin;
            saveData();
            closeModal('modal-admin');
        }

        // --- REPORTING ---
        function sendReport() {
            let d = new Date();
            let msg = `*üìä POINT DU ${d.toLocaleDateString()} ${d.toLocaleTimeString()}* %0a`;
            
            // Calculs locaux pour le message
            let s = appData.products.reduce((acc, p) => acc + (p.sold * p.price), 0);
            let e = appData.expenses.reduce((acc, ex) => acc + ex.amount, 0);
            
            appData.products.forEach(p => {
                if(p.sold > 0) msg += `üç∫ ${p.name}: ${p.sold} (Reste: ${p.stock})%0a`;
            });

            msg += `--------------------------------%0a`;
            msg += `üí∞ Ventes: *${s.toLocaleString()} F*%0a`;
            if(e > 0) msg += `üîª Sorties: -${e.toLocaleString()} F%0a`;
            msg += `üíµ *CAISSE NETTE : ${(s-e).toLocaleString()} F*`;

            window.open(`https://wa.me/?text=${msg}`, '_blank');
        }

        renderUI();
    </script>
</body>
</html>
